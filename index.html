<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Attendance System - Professional GPS + Camera + Map Solution</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Smart Attendance">
    <meta name="theme-color" content="#0f3460">
    <meta name="description" content="Professional Attendance System with GPS, Camera, and Live Map Tracking">
    
    <style>
        /* ========== CSS RESET & BASE STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }
        
        :root {
            --primary-color: #0f3460;
            --secondary-color: #1a1a2e;
            --accent-color: #ff9a00;
            --accent-gradient: linear-gradient(135deg, #ff9a00 0%, #ff5e00 100%);
            --success-color: #00b09b;
            --success-gradient: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            --warning-color: #ff9a00;
            --danger-color: #ff416c;
            --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            --info-color: #4a6fa5;
            --light-bg: #f8f9fa;
            --dark-bg: #121212;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-light: #ffffff;
            --border-color: #e1e8f0;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 20px 50px rgba(0, 0, 0, 0.2);
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 20px;
            --border-radius-xl: 30px;
            --transition-fast: 0.2s;
            --transition-normal: 0.3s;
            --transition-slow: 0.5s;
            --sidebar-width: 280px;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 16px;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* ========== CUSTOM SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--accent-gradient);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #ff5e00 0%, #ff9a00 100%);
        }
        
        /* ========== LOADING OVERLAY ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 52, 96, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            visibility: visible;
            transition: opacity var(--transition-slow), visibility var(--transition-slow);
            backdrop-filter: blur(10px);
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            position: relative;
        }
        
        .loading-spinner::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 5px solid transparent;
            border-radius: 50%;
            border-top-color: var(--success-color);
            animation: spin 1.5s linear infinite reverse;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            font-size: 1.2rem;
            font-weight: 500;
            margin-top: 15px;
            text-align: center;
            max-width: 300px;
        }
        
        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: var(--accent-gradient);
            width: 0%;
            transition: width 0.3s;
            border-radius: 2px;
        }
        
        /* ========== APP CONTAINER ========== */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            min-height: 100vh;
        }
        
        /* ========== HEADER ========== */
        .app-header {
            background: rgba(15, 52, 96, 0.9);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--accent-gradient);
            animation: headerGlow 3s ease-in-out infinite;
        }
        
        @keyframes headerGlow {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .app-logo {
            width: 70px;
            height: 70px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 8px 25px rgba(255, 154, 0, 0.4);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .app-title {
            color: white;
        }
        
        .app-title h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 5px;
            background: linear-gradient(90deg, #ff9a00, #ffffff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .app-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        /* ========== ACTION BUTTONS ========== */
        .action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .action-btn.active {
            background: var(--accent-gradient);
        }
        
        .action-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }
        
        /* ========== MAIN CONTENT GRID ========== */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        @media (min-width: 992px) {
            .main-content {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        /* ========== SIDEBAR ========== */
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
            position: sticky;
            top: 30px;
        }
        
        .sidebar-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(15, 52, 96, 0.1);
        }
        
        .sidebar-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .sidebar-title {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .sidebar-title i {
            color: var(--accent-color);
        }
        
        /* ========== STATS CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--border-radius-md);
            padding: 15px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 1.2rem;
        }
        
        .stat-icon.today {
            background: rgba(0, 176, 155, 0.1);
            color: var(--success-color);
        }
        
        .stat-icon.total {
            background: rgba(255, 154, 0, 0.1);
            color: var(--accent-color);
        }
        
        .stat-icon.month {
            background: rgba(74, 111, 165, 0.1);
            color: var(--info-color);
        }
        
        .stat-icon.accuracy {
            background: rgba(255, 65, 108, 0.1);
            color: var(--danger-color);
        }
        
        /* ========== QUICK ACTIONS ========== */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 10px;
            background: white;
            border: 2px solid transparent;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: center;
        }
        
        .quick-action-btn:hover {
            border-color: var(--accent-color);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .quick-action-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 1.2rem;
            background: var(--accent-gradient);
            color: white;
        }
        
        .quick-action-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* ========== MAIN CONTENT AREA ========== */
        .content-area {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        /* ========== TABS NAVIGATION ========== */
        .tabs-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .tabs-header {
            display: flex;
            background: rgba(15, 52, 96, 0.05);
            border-bottom: 1px solid rgba(15, 52, 96, 0.1);
            padding: 5px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 18px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
        }
        
        .tab-btn:hover {
            color: var(--primary-color);
        }
        
        .tab-btn.active {
            color: white;
            background: var(--accent-gradient);
            border-radius: var(--border-radius-md);
            box-shadow: 0 5px 15px rgba(255, 154, 0, 0.3);
        }
        
        .tab-badge {
            background: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 5px;
        }
        
        .tabs-content {
            padding: 0;
        }
        
        .tab-pane {
            display: none;
            animation: fadeIn var(--transition-normal);
        }
        
        .tab-pane.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ========== CARD COMPONENT ========== */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(15, 52, 96, 0.1);
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .card-title i {
            color: var(--accent-color);
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
        }
        
        /* ========== FORM CONTROLS ========== */
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        .input-group {
            position: relative;
        }
        
        .input-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 1.1rem;
            z-index: 1;
        }
        
        .form-control {
            width: 100%;
            padding: 18px 18px 18px 50px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: 16px;
            background: white;
            color: var(--text-primary);
            transition: all var(--transition-normal);
            position: relative;
        }
        
        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(255, 154, 0, 0.1);
            outline: none;
        }
        
        .form-control.error {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(255, 65, 108, 0.1);
        }
        
        .form-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-hint i {
            color: var(--accent-color);
        }
        
        /* ========== AUTOCOMPLETE ========== */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            border: 2px solid var(--accent-color);
            border-top: none;
        }
        
        .autocomplete-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .autocomplete-item:hover {
            background: rgba(255, 154, 0, 0.1);
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .employee-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .employee-info {
            flex: 1;
        }
        
        .employee-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .employee-id {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* ========== MAP CONTAINER ========== */
        .map-container {
            width: 100%;
            height: 350px;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            margin-bottom: 20px;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
        }
        
        #map, #liveMap {
            width: 100%;
            height: 100%;
        }
        
        .location-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .location-stat {
            background: rgba(15, 52, 96, 0.05);
            padding: 15px;
            border-radius: var(--border-radius-md);
            border-left: 4px solid var(--accent-color);
        }
        
        .location-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .location-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        /* ========== CAMERA SECTION ========== */
        .camera-wrapper {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            margin-bottom: 20px;
            background: #000;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
        }
        
        .camera-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #aaa;
            background: linear-gradient(45deg, #0a0a0a 0%, #1a1a1a 100%);
        }
        
        .camera-placeholder i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        #cameraPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            transform: scaleX(-1);
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            background: radial-gradient(circle, transparent 50%, rgba(0, 0, 0, 0.3) 100%);
        }
        
        .camera-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 3px solid rgba(255, 154, 0, 0.5);
            border-radius: 50%;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
        }
        
        .camera-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* ========== BUTTON STYLES ========== */
        .btn {
            padding: 18px 30px;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn-lg {
            padding: 20px 40px;
            font-size: 1.1rem;
        }
        
        .btn-sm {
            padding: 12px 24px;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #0a2a4d;
            box-shadow: 0 10px 20px rgba(15, 52, 96, 0.3);
        }
        
        .btn-accent {
            background: var(--accent-gradient);
            color: white;
        }
        
        .btn-accent:hover {
            background: linear-gradient(135deg, #ff5e00 0%, #ff9a00 100%);
            box-shadow: 0 10px 20px rgba(255, 154, 0, 0.3);
        }
        
        .btn-success {
            background: var(--success-gradient);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #96c93d 0%, #00b09b 100%);
            box-shadow: 0 10px 20px rgba(0, 176, 155, 0.3);
        }
        
        .btn-danger {
            background: var(--danger-gradient);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #ff4b2b 0%, #ff416c 100%);
            box-shadow: 0 10px 20px rgba(255, 65, 108, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        
        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-outline-accent {
            background: transparent;
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
        }
        
        .btn-outline-accent:hover {
            background: var(--accent-color);
            color: white;
        }
        
        /* ========== PHOTO PREVIEW ========== */
        .photo-preview {
            display: none;
            margin-top: 30px;
            animation: fadeIn var(--transition-slow);
        }
        
        .photo-container {
            position: relative;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
        }
        
        #capturedPhoto {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            background: #f8f9fa;
        }
        
        .photo-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .photo-metadata {
            background: rgba(15, 52, 96, 0.05);
            border-radius: var(--border-radius-md);
            padding: 25px;
            border-left: 5px solid var(--accent-color);
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .metadata-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .metadata-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .metadata-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        .verification-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 176, 155, 0.1);
            color: var(--success-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .verification-badge.error {
            background: rgba(255, 65, 108, 0.1);
            color: var(--danger-color);
        }
        
        /* ========== RECORDS SECTION ========== */
        .records-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .record-card {
            background: white;
            border-radius: var(--border-radius-md);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            cursor: pointer;
            position: relative;
        }
        
        .record-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-color);
        }
        
        .record-card.selected {
            border-color: var(--accent-color);
            background: rgba(255, 154, 0, 0.05);
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .record-employee {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .record-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .record-info h4 {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .record-department {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .record-time {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .record-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(15, 52, 96, 0.1);
        }
        
        .record-detail {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .record-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .record-value {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .record-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .record-card:hover .record-actions {
            opacity: 1;
        }
        
        /* ========== FILTERS BAR ========== */
        .filters-bar {
            background: white;
            border-radius: var(--border-radius-md);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--border-color);
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        /* ========== TOAST NOTIFICATIONS ========== */
        .toast-container {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 9998;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
        }
        
        .toast {
            background: white;
            border-radius: var(--border-radius-md);
            padding: 20px;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(150%);
            transition: transform var(--transition-normal);
            border-left: 5px solid var(--accent-color);
            position: relative;
            overflow: hidden;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast::before {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100%;
            height: 3px;
            background: var(--accent-color);
            animation: toastProgress 3s linear forwards;
        }
        
        @keyframes toastProgress {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        .toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .toast.success .toast-icon {
            background: rgba(0, 176, 155, 0.1);
            color: var(--success-color);
        }
        
        .toast.error .toast-icon {
            background: rgba(255, 65, 108, 0.1);
            color: var(--danger-color);
        }
        
        .toast.warning .toast-icon {
            background: rgba(255, 154, 0, 0.1);
            color: var(--accent-color);
        }
        
        .toast.info .toast-icon {
            background: rgba(74, 111, 165, 0.1);
            color: var(--info-color);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }
        
        .toast-message {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }
        
        /* ========== MODAL DIALOGS ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .modal-overlay.show {
            display: flex;
            animation: fadeIn var(--transition-fast);
        }
        
        .modal {
            background: white;
            border-radius: var(--border-radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp var(--transition-normal);
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid rgba(15, 52, 96, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-fast);
        }
        
        .modal-close:hover {
            color: var(--danger-color);
            background: rgba(255, 65, 108, 0.1);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .modal-footer {
            padding: 25px 30px;
            border-top: 2px solid rgba(15, 52, 96, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        /* ========== SETTINGS PANEL ========== */
        .settings-panel {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 30px;
        }
        
        .setting-group {
            margin-bottom: 30px;
        }
        
        .setting-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-radius: var(--border-radius-md);
            background: rgba(15, 52, 96, 0.03);
            margin-bottom: 10px;
            transition: background var(--transition-fast);
        }
        
        .setting-item:hover {
            background: rgba(15, 52, 96, 0.05);
        }
        
        .setting-label {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .setting-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .setting-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* ========== SWITCH TOGGLE ========== */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: var(--transition-normal);
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: var(--transition-normal);
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: var(--accent-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* ========== FLOATING ACTION BUTTONS ========== */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 100;
        }
        
        .fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: var(--accent-gradient);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255, 154, 0, 0.3);
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 15px 40px rgba(255, 154, 0, 0.4);
        }
        
        .fab-label {
            position: absolute;
            right: 70px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            white-space: nowrap;
            opacity: 0;
            transform: translateX(20px);
            transition: all var(--transition-normal);
            pointer-events: none;
        }
        
        .fab:hover .fab-label {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* ========== HELP TOUR ========== */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9997;
            display: none;
        }
        
        .tour-step {
            position: absolute;
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 25px;
            max-width: 400px;
            box-shadow: var(--shadow-xl);
            z-index: 9998;
            animation: pulse 2s infinite;
        }
        
        .tour-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }
        
        .tour-step.top .tour-arrow {
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 10px 10px 0 10px;
            border-color: white transparent transparent transparent;
        }
        
        .tour-step.bottom .tour-arrow {
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 10px 10px 10px;
            border-color: transparent transparent white transparent;
        }
        
        .tour-step.left .tour-arrow {
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            border-width: 10px 0 10px 10px;
            border-color: transparent transparent transparent white;
        }
        
        .tour-step.right .tour-arrow {
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            border-width: 10px 10px 10px 0;
            border-color: transparent white transparent transparent;
        }
        
        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 992px) {
            .app-container {
                padding: 15px;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                margin-bottom: 30px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 30px;
            }
            
            .tabs-header {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                min-width: 140px;
            }
        }
        
        @media (max-width: 768px) {
            .card {
                padding: 20px;
            }
            
            .modal {
                width: 95%;
            }
            
            .filters-bar {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .camera-controls {
                grid-template-columns: 1fr;
            }
            
            .photo-actions {
                grid-template-columns: 1fr;
            }
            
            .location-stats {
                grid-template-columns: 1fr;
            }
            
            .metadata-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .app-header {
                padding: 15px;
            }
            
            .app-title h1 {
                font-size: 1.8rem;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        
            .btn {
                padding: 15px 20px;
            }
            
            .form-control {
                padding: 15px 15px 15px 45px;
            }
            
            .tab-btn {
                padding: 15px;
                font-size: 0.9rem;
            }
            
            .fab-container {
                bottom: 20px;
                right: 20px;
            }
            
            .toast-container {
                top: 20px;
                right: 20px;
                left: 20px;
            }
            
            .toast {
                max-width: 100%;
            }
        }
        
        /* ========== DARK MODE SUPPORT ========== */
        @media (prefers-color-scheme: dark) {
            :root {
                --light-bg: #1e1e1e;
                --text-primary: #ffffff;
                --text-secondary: #aaaaaa;
                --border-color: #333333;
            }
            
            .card, .sidebar, .tabs-container {
                background: rgba(40, 40, 40, 0.95);
            }
            
            .form-control {
                background: #2a2a2a;
                color: white;
                border-color: #444;
            }
            
            .record-card {
                background: #2a2a2a;
                border-color: #333;
            }
            
            .stat-card {
                background: #2a2a2a;
                border-color: #333;
            }
            
            .empty-state i {
                color: #444;
            }
            
            .filters-bar {
                background: #2a2a2a;
            }
            
            .modal {
                background: #2a2a2a;
            }
            
            .modal-title {
                color: white;
            }
            
            .settings-panel {
                background: #2a2a2a;
            }
            
            .setting-item {
                background: rgba(255, 255, 255, 0.05);
            }
        }
        
        /* ========== PRINT STYLES ========== */
        @media print {
            .app-header, .sidebar, .fab-container, .action-btn, .btn {
                display: none !important;
            }
            
            .card {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Initializing Smart Attendance System...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgress"></div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Modal Dialogs Container -->
    <div id="modalContainer"></div>
    
    <!-- Help Tour Overlay -->
    <div class="tour-overlay" id="tourOverlay"></div>
    
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="app-logo">
                        <i class="fas fa-fingerprint"></i>
                    </div>
                    <div class="app-title">
                        <h1>Smart Attendance Pro</h1>
                        <p class="app-subtitle">GPS + Camera + Real-time Tracking System</p>
                    </div>
                </div>
                
                <div class="header-actions">
                    <button class="action-btn" id="voiceGuideBtn" title="Toggle Voice Guide">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button class="action-btn" id="helpBtn" title="Help & Tutorial">
                        <i class="fas fa-question-circle"></i>
                    </button>
                    <button class="action-btn" id="themeToggle" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="action-btn" id="notificationsBtn" title="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="notificationCount">3</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Content Area -->
            <div class="content-area">
                <!-- Tabs Navigation -->
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="attendance">
                            <i class="fas fa-camera"></i>
                            Mark Attendance
                            <span class="tab-badge" id="attendanceBadge">0</span>
                        </button>
                        <button class="tab-btn" data-tab="records">
                            <i class="fas fa-history"></i>
                            Records
                            <span class="tab-badge" id="recordsBadge">0</span>
                        </button>
                        <button class="tab-btn" data-tab="map">
                            <i class="fas fa-map-marked-alt"></i>
                            Live Map
                        </button>
                        <button class="tab-btn" data-tab="analytics">
                            <i class="fas fa-chart-bar"></i>
                            Analytics
                        </button>
                        <button class="tab-btn" data-tab="settings">
                            <i class="fas fa-cog"></i>
                            Settings
                        </button>
                    </div>
                    
                    <div class="tabs-content">
                        <!-- Attendance Tab -->
                        <div class="tab-pane active" id="attendanceTab">
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">
                                        <i class="fas fa-user-check"></i>
                                        Employee Information
                                    </h2>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-outline-accent" id="scanIdBtn">
                                            <i class="fas fa-qrcode"></i> Scan ID
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Employee Name *</label>
                                    <div class="autocomplete-container">
                                        <div class="input-group">
                                            <i class="fas fa-user input-icon"></i>
                                            <input type="text" class="form-control" id="employeeName" 
                                                   placeholder="Enter employee name or scan ID" 
                                                   autocomplete="off">
                                        </div>
                                        <div class="autocomplete-dropdown" id="nameAutocomplete"></div>
                                    </div>
                                    <div class="form-hint">
                                        <i class="fas fa-lightbulb"></i>
                                        Start typing to see suggestions or scan employee ID card
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Employee ID *</label>
                                    <div class="input-group">
                                        <i class="fas fa-id-card input-icon"></i>
                                        <input type="text" class="form-control" id="employeeId" 
                                               placeholder="Employee ID">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Department *</label>
                                    <div class="input-group">
                                        <i class="fas fa-building input-icon"></i>
                                        <select class="form-control" id="department">
                                            <option value="">Select Department</option>
                                            <option value="Panchayat Development">Panchayat Development</option>
                                            <option value="Health Services">Health Services</option>
                                            <option value="Education">Education</option>
                                            <option value="Administration">Administration</option>
                                            <option value="Field Operations">Field Operations</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Designation</label>
                                    <div class="input-group">
                                        <i class="fas fa-briefcase input-icon"></i>
                                        <input type="text" class="form-control" id="designation" 
                                               placeholder="Employee Designation">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- GPS Location Card -->
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Location Verification
                                    </h2>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-accent" id="refreshLocationBtn">
                                            <i class="fas fa-sync-alt"></i> Refresh
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="map-container">
                                    <div id="map"></div>
                                </div>
                                
                                <div class="location-stats">
                                    <div class="location-stat">
                                        <div class="location-label">GPS Status</div>
                                        <div class="location-value" id="gpsStatus">
                                            <i class="fas fa-circle-notch fa-spin"></i> Initializing...
                                        </div>
                                    </div>
                                    <div class="location-stat">
                                        <div class="location-label">Coordinates</div>
                                        <div class="location-value" id="coordinates">-</div>
                                    </div>
                                    <div class="location-stat">
                                        <div class="location-label">Address</div>
                                        <div class="location-value" id="address">-</div>
                                    </div>
                                    <div class="location-stat">
                                        <div class="location-label">Accuracy</div>
                                        <div class="location-value" id="accuracy">-</div>
                                    </div>
                                </div>
                                
                                <div class="form-hint" style="margin-top: 15px;">
                                    <i class="fas fa-info-circle"></i>
                                    Location is automatically captured for attendance verification. Make sure GPS is enabled.
                                </div>
                            </div>
                            
                            <!-- Camera Card -->
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">
                                        <i class="fas fa-camera"></i>
                                        Photo Capture
                                    </h2>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-outline-accent" id="switchCameraBtn">
                                            <i class="fas fa-sync"></i> Switch Camera
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="camera-wrapper">
                                    <div class="camera-placeholder" id="cameraPlaceholder">
                                        <i class="fas fa-camera"></i>
                                        <p>Camera will appear here</p>
                                        <p style="font-size: 0.9rem; margin-top: 10px;">Tap 'Start Camera' to begin</p>
                                    </div>
                                    <video id="cameraPreview" autoplay playsinline></video>
                                    <div class="camera-overlay"></div>
                                    <div class="camera-frame"></div>
                                </div>
                                
                                <div class="camera-controls">
                                    <button class="btn btn-accent" id="startCameraBtn">
                                        <i class="fas fa-video"></i> Start Camera
                                    </button>
                                    <button class="btn btn-success" id="capturePhotoBtn" disabled>
                                        <i class="fas fa-camera-retro"></i> Capture Photo
                                    </button>
                                </div>
                                
                                <div class="form-hint">
                                    <i class="fas fa-lightbulb"></i>
                                    Tips: Ensure good lighting, face the camera directly, and keep steady while capturing.
                                </div>
                            </div>
                            
                            <!-- Photo Preview Section -->
                            <div class="photo-preview" id="photoPreview">
                                <div class="card">
                                    <div class="card-header">
                                        <h2 class="card-title">
                                            <i class="fas fa-check-circle"></i>
                                            Photo Preview
                                        </h2>
                                        <div class="card-actions">
                                            <button class="btn btn-sm btn-outline-accent" id="editPhotoBtn">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="photo-container">
                                        <img id="capturedPhoto" alt="Captured Attendance Photo">
                                    </div>
                                    
                                    <div class="photo-actions">
                                        <button class="btn btn-outline-accent" id="retakePhotoBtn">
                                            <i class="fas fa-redo"></i> Retake Photo
                                        </button>
                                        <button class="btn btn-success" id="submitAttendanceBtn">
                                            <i class="fas fa-paper-plane"></i> Submit Attendance
                                        </button>
                                    </div>
                                    
                                    <div class="photo-metadata">
                                        <div class="metadata-grid">
                                            <div class="metadata-item">
                                                <span class="metadata-label">
                                                    <i class="fas fa-user"></i> Employee Name
                                                </span>
                                                <span class="metadata-value" id="metaName">-</span>
                                            </div>
                                            <div class="metadata-item">
                                                <span class="metadata-label">
                                                    <i class="fas fa-id-card"></i> Employee ID
                                                </span>
                                                <span class="metadata-value" id="metaId">-</span>
                                            </div>
                                            <div class="metadata-item">
                                                <span class="metadata-label">
                                                    <i class="fas fa-building"></i> Department
                                                </span>
                                                <span class="metadata-value" id="metaDepartment">-</span>
                                            </div>
                                            <div class="metadata-item">
                                                <span class="metadata-label">
                                                    <i class="fas fa-clock"></i> Date & Time
                                                </span>
                                                <span class="metadata-value" id="metaDateTime">-</span>
                                            </div>
                                            <div class="metadata-item">
                                                <span class="metadata-label">
                                                    <i class="fas fa-map-marker-alt"></i> Location
                                                </span>
                                                <span class="metadata-value" id="metaLocation">-</span>
                                            </div>
                                            <div class="metadata-item">
                                                <span class="metadata-label">
                                                    <i class="fas fa-shield-alt"></i> Verification
                                                </span>
                                                <span class="metadata-value">
                                                    <span class="verification-badge" id="metaVerification">
                                                        <i class="fas fa-clock"></i> Pending
                                                    </span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Records Tab -->
                        <div class="tab-pane" id="recordsTab">
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">
                                        <i class="fas fa-clipboard-list"></i>
                                        Attendance Records
                                    </h2>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-accent" id="syncRecordsBtn">
                                            <i class="fas fa-cloud-upload-alt"></i> Sync
                                        </button>
                                        <button class="btn btn-sm btn-danger" id="clearFilterBtn">
                                            <i class="fas fa-filter"></i> Clear Filters
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="filters-bar">
                                    <div class="filter-group">
                                        <label class="form-label">Date Range</label>
                                        <div class="input-group">
                                            <i class="fas fa-calendar input-icon"></i>
                                            <input type="date" class="form-control" id="dateFrom">
                                        </div>
                                    </div>
                                    
                                    <div class="filter-group">
                                        <label class="form-label">To</label>
                                        <div class="input-group">
                                            <i class="fas fa-calendar input-icon"></i>
                                            <input type="date" class="form-control" id="dateTo">
                                        </div>
                                    </div>
                                    
                                    <div class="filter-group">
                                        <label class="form-label">Department</label>
                                        <div class="input-group">
                                            <i class="fas fa-building input-icon"></i>
                                            <select class="form-control" id="filterDepartment">
                                                <option value="">All Departments</option>
                                                <option value="Panchayat Development">Panchayat Development</option>
                                                <option value="Health Services">Health Services</option>
                                                <option value="Education">Education</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="filter-group">
                                        <label class="form-label">Search</label>
                                        <div class="input-group">
                                            <i class="fas fa-search input-icon"></i>
                                            <input type="text" class="form-control" id="searchRecords" 
                                                   placeholder="Search by name or ID">
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-accent" id="applyFilterBtn">
                                        <i class="fas fa-filter"></i> Apply Filters
                                    </button>
                                </div>
                                
                                <div class="records-container" id="recordsContainer">
                                    <div class="empty-state">
                                        <i class="fas fa-clipboard"></i>
                                        <h3>No Records Found</h3>
                                        <p>Start marking attendance to see records here</p>
                                    </div>
                                </div>
                                
                                <div class="card-actions" style="margin-top: 20px;">
                                    <button class="btn btn-outline-accent" id="exportCsvBtn">
                                        <i class="fas fa-file-csv"></i> Export as CSV
                                    </button>
                                    <button class="btn btn-outline-accent" id="exportPdfBtn">
                                        <i class="fas fa-file-pdf"></i> Export as PDF
                                    </button>
                                    <button class="btn btn-danger" id="deleteSelectedBtn">
                                        <i class="fas fa-trash"></i> Delete Selected
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Map Tab -->
                        <div class="tab-pane" id="mapTab">
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">
                                        <i class="fas fa-globe-asia"></i>
                                        Live GPS Tracking Map
                                    </h2>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-accent" id="liveTrackingBtn">
                                            <i class="fas fa-satellite"></i> Live Tracking
                                        </button>
                                        <button class="btn btn-sm btn-outline-accent" id="showHeatmapBtn">
                                            <i class="fas fa-fire"></i> Heatmap
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="map-container" style="height: 500px;">
                                    <div id="liveMap"></div>
                                </div>
                                
                                <div class="location-stats" style="margin-top: 20px;">
                                    <div class="location-stat">
                                        <div class="location-label">Latitude</div>
                                        <div class="location-value" id="liveLat">-</div>
                                    </div>
                                    <div class="location-stat">
                                        <div class="location-label">Longitude</div>
                                        <div class="location-value" id="liveLon">-</div>
                                    </div>
                                    <div class="location-stat">
                                        <div class="location-label">Speed</div>
                                        <div class="location-value" id="liveSpeed">-</div>
                                    </div>
                                    <div class="location-stat">
                                        <div class="location-label">Heading</div>
                                        <div class="location-value" id="liveHeading">-</div>
                                    </div>
                                    <div class="location-stat">
                                        <div class="location-label">Altitude</div>
                                        <div class="location-value" id="liveAltitude">-</div>
                                    </div>
                                    <div class="location-stat">
                                        <div class="location-label">Satellites</div>
                                        <div class="location-value" id="liveSatellites">-</div>
                                    </div>
                                </div>
                                
                                <button class="btn btn-accent btn-block" id="startLiveTrackingBtn" style="margin-top: 20px;">
                                    <i class="fas fa-play-circle"></i> Start Live Tracking
                                </button>
                            </div>
                        </div>
                        
                        <!-- Analytics Tab -->
                        <div class="tab-pane" id="analyticsTab">
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">
                                        <i class="fas fa-chart-bar"></i>
                                        Attendance Analytics
                                    </h2>
                                    <div class="card-actions">
                                        <select class="form-control" id="analyticsPeriod" style="width: auto;">
                                            <option value="week">This Week</option>
                                            <option value="month">This Month</option>
                                            <option value="quarter">This Quarter</option>
                                            <option value="year">This Year</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="analytics-charts" id="analyticsCharts">
                                    <!-- Charts will be generated here -->
                                    <div class="empty-state">
                                        <i class="fas fa-chart-line"></i>
                                        <h3>Analytics Dashboard</h3>
                                        <p>Collect more data to see analytics</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Settings Tab -->
                        <div class="tab-pane" id="settingsTab">
                            <div class="settings-panel">
                                <div class="setting-group">
                                    <h3 class="setting-title">
                                        <i class="fas fa-user-cog"></i>
                                        General Settings
                                    </h3>
                                    
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span class="setting-name">Voice Guidance</span>
                                            <span class="setting-description">Enable voice prompts for actions</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="voiceGuideToggle" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span class="setting-name">Auto-save Photos</span>
                                            <span class="setting-description">Automatically save captured photos to gallery</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="autoSaveToggle" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span class="setting-name">GPS Accuracy</span>
                                            <span class="setting-description">Set minimum GPS accuracy for attendance</span>
                                        </div>
                                        <select class="form-control" id="gpsAccuracy" style="width: auto;">
                                            <option value="10">High (10 meters)</option>
                                            <option value="50" selected>Medium (50 meters)</option>
                                            <option value="100">Low (100 meters)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <h3 class="setting-title">
                                        <i class="fas fa-camera"></i>
                                        Camera Settings
                                    </h3>
                                    
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span class="setting-name">Camera Quality</span>
                                            <span class="setting-description">Set photo quality and resolution</span>
                                        </div>
                                        <select class="form-control" id="cameraQuality" style="width: auto;">
                                            <option value="low">Low (Fast)</option>
                                            <option value="medium" selected>Medium (Balanced)</option>
                                            <option value="high">High (Best)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span class="setting-name">Flash Mode</span>
                                            <span class="setting-description">Camera flash behavior</span>
                                        </div>
                                        <select class="form-control" id="flashMode" style="width: auto;">
                                            <option value="off">Off</option>
                                            <option value="on">On</option>
                                            <option value="auto" selected>Auto</option>
                                        </select>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span class="setting-name">Front Camera</span>
                                            <span class="setting-description">Use front camera by default</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="frontCameraToggle" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <h3 class="setting-title">
                                        <i class="fas fa-database"></i>
                                        Data Management
                                    </h3>
                                    
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span class="setting-name">Auto Backup</span>
                                            <span class="setting-description">Automatically backup data daily</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="autoBackupToggle" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span class="setting-name">Sync to Cloud</span>
                                            <span class="setting-description">Sync data to cloud when online</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="cloudSyncToggle">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <span class="setting-name">Max Records</span>
                                            <span class="setting-description">Maximum records to store locally</span>
                                        </div>
                                        <select class="form-control" id="maxRecords" style="width: auto;">
                                            <option value="1000">1000 records</option>
                                            <option value="5000" selected>5000 records</option>
                                            <option value="10000">10000 records</option>
                                            <option value="unlimited">Unlimited</option>
                                        </select>
                                    </div>
                                    
                                    <div class="card-actions" style="margin-top: 30px;">
                                        <button class="btn btn-accent" id="backupDataBtn">
                                            <i class="fas fa-save"></i> Backup Data
                                        </button>
                                        <button class="btn btn-outline-accent" id="restoreDataBtn">
                                            <i class="fas fa-history"></i> Restore Backup
                                        </button>
                                        <button class="btn btn-danger" id="clearDataBtn">
                                            <i class="fas fa-trash"></i> Clear All Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar -->
            <div class="sidebar">
                <!-- Today's Stats -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-chart-pie"></i>
                        Today's Summary
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon today">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div class="stat-value" id="statToday">0</div>
                            <div class="stat-label">Today's Attendance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon total">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="stat-value" id="statTotal">0</div>
                            <div class="stat-label">Total Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon month">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-value" id="statMonth">0</div>
                            <div class="stat-label">This Month</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon accuracy">
                                <i class="fas fa-bullseye"></i>
                            </div>
                            <div class="stat-value" id="statAccuracy">0m</div>
                            <div class="stat-label">Avg Accuracy</div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-bolt"></i>
                        Quick Actions
                    </h3>
                    <div class="quick-actions-grid">
                        <button class="quick-action-btn" id="quickMarkBtn">
                            <div class="quick-action-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <span class="quick-action-label">Quick Mark</span>
                        </button>
                        <button class="quick-action-btn" id="viewTodayBtn">
                            <div class="quick-action-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <span class="quick-action-label">Today's Log</span>
                        </button>
                        <button class="quick-action-btn" id="exportDataBtn">
                            <div class="quick-action-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <span class="quick-action-label">Export Data</span>
                        </button>
                        <button class="quick-action-btn" id="syncNowBtn">
                            <div class="quick-action-icon">
                                <i class="fas fa-sync-alt"></i>
                            </div>
                            <span class="quick-action-label">Sync Now</span>
                        </button>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-history"></i>
                        Recent Activity
                    </h3>
                    <div class="recent-activity" id="recentActivity">
                        <div class="empty-state" style="padding: 20px 0;">
                            <i class="fas fa-history"></i>
                            <p>No recent activity</p>
                        </div>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="fas fa-server"></i>
                        System Status
                    </h3>
                    <div class="system-status">
                        <div class="status-item">
                            <span class="status-label">GPS</span>
                            <span class="status-value status-active" id="statusGps">
                                <i class="fas fa-circle"></i> Active
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Camera</span>
                            <span class="status-value status-inactive" id="statusCamera">
                                <i class="fas fa-circle"></i> Ready
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Storage</span>
                            <span class="status-value status-active" id="statusStorage">
                                <i class="fas fa-circle"></i> 85%
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Battery</span>
                            <span class="status-value status-active" id="statusBattery">
                                <i class="fas fa-circle"></i> 72%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Buttons -->
    <div class="fab-container">
        <button class="fab" id="mainFab" title="Quick Actions">
            <i class="fas fa-plus"></i>
            <span class="fab-label">Quick Actions</span>
        </button>
        <button class="fab" id="helpFab" title="Help">
            <i class="fas fa-question"></i>
            <span class="fab-label">Help & Support</span>
        </button>
        <button class="fab" id="emergencyFab" title="Emergency">
            <i class="fas fa-exclamation-triangle"></i>
            <span class="fab-label">Emergency</span>
        </button>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- HTML2Canvas for Photo Capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <script>
        // ============================================
        // SMART ATTENDANCE SYSTEM - MAIN APPLICATION
        // ============================================
        // Version: 3.0.0
        // Author: Smart Attendance Pro
        // Features: GPS, Camera, Map, Analytics, PWA
        // ============================================
        
        'use strict';
        
        // Application Configuration
        const CONFIG = {
            APP_NAME: 'Smart Attendance Pro',
            VERSION: '3.0.0',
            MAX_RECORDS: 5000,
            GPS_ACCURACY_THRESHOLD: 50, // meters
            CAMERA_QUALITY: 0.8,
            AUTO_BACKUP_INTERVAL: 24 * 60 * 60 * 1000, // 24 hours
            SESSION_TIMEOUT: 30 * 60 * 1000, // 30 minutes
            DEMO_MODE: false,
            API_ENDPOINTS: {
                GEOCODING: 'https://nominatim.openstreetmap.org/reverse',
                IP_LOCATION: 'https://ipapi.co/json/'
            }
        };
        
        // Application State
        const APP_STATE = {
            // Core State
            isLoading: true,
            isOnline: navigator.onLine,
            isDarkMode: window.matchMedia('(prefers-color-scheme: dark)').matches,
            isFullscreen: false,
            
            // User State
            currentUser: null,
            userSettings: {},
            permissions: {
                camera: false,
                location: false,
                notifications: false
            },
            
            // Data State
            attendanceRecords: [],
            employees: [],
            departments: [],
            recentActivity: [],
            
            // Device State
            currentLocation: null,
            locationWatchId: null,
            locationHistory: [],
            batteryLevel: 100,
            networkType: 'unknown',
            
            // Camera State
            cameraStream: null,
            cameraActive: false,
            currentCamera: 'user',
            flashEnabled: false,
            capturedPhoto: null,
            
            // Map State
            mainMap: null,
            liveMap: null,
            userMarker: null,
            trackingInterval: null,
            
            // UI State
            activeTab: 'attendance',
            selectedRecords: new Set(),
            filters: {},
            searchQuery: '',
            
            // Analytics State
            analyticsData: {},
            charts: {},
            
            // Settings State
            settings: {
                voiceGuide: true,
                autoSave: true,
                gpsAccuracy: 50,
                cameraQuality: 'medium',
                flashMode: 'auto',
                frontCamera: true,
                autoBackup: true,
                cloudSync: false,
                maxRecords: 5000
            }
        };
        
        // DOM Elements
        const DOM = {};
        
        // Initialize DOM references
        function initDOMReferences() {
            // Loading Elements
            DOM.loadingOverlay = document.getElementById('loadingOverlay');
            DOM.loadingText = document.getElementById('loadingText');
            DOM.loadingProgress = document.getElementById('loadingProgress');
            
            // Header Elements
            DOM.voiceGuideBtn = document.getElementById('voiceGuideBtn');
            DOM.helpBtn = document.getElementById('helpBtn');
            DOM.themeToggle = document.getElementById('themeToggle');
            DOM.notificationsBtn = document.getElementById('notificationsBtn');
            DOM.notificationCount = document.getElementById('notificationCount');
            
            // Tab Elements
            DOM.tabBtns = document.querySelectorAll('.tab-btn');
            DOM.tabPanes = document.querySelectorAll('.tab-pane');
            DOM.attendanceBadge = document.getElementById('attendanceBadge');
            DOM.recordsBadge = document.getElementById('recordsBadge');
            
            // Attendance Form Elements
            DOM.employeeName = document.getElementById('employeeName');
            DOM.employeeId = document.getElementById('employeeId');
            DOM.department = document.getElementById('department');
            DOM.designation = document.getElementById('designation');
            DOM.nameAutocomplete = document.getElementById('nameAutocomplete');
            DOM.scanIdBtn = document.getElementById('scanIdBtn');
            
            // GPS Elements
            DOM.gpsStatus = document.getElementById('gpsStatus');
            DOM.coordinates = document.getElementById('coordinates');
            DOM.address = document.getElementById('address');
            DOM.accuracy = document.getElementById('accuracy');
            DOM.refreshLocationBtn = document.getElementById('refreshLocationBtn');
            DOM.map = document.getElementById('map');
            
            // Camera Elements
            DOM.cameraPlaceholder = document.getElementById('cameraPlaceholder');
            DOM.cameraPreview = document.getElementById('cameraPreview');
            DOM.startCameraBtn = document.getElementById('startCameraBtn');
            DOM.capturePhotoBtn = document.getElementById('capturePhotoBtn');
            DOM.switchCameraBtn = document.getElementById('switchCameraBtn');
            
            // Photo Preview Elements
            DOM.photoPreview = document.getElementById('photoPreview');
            DOM.capturedPhoto = document.getElementById('capturedPhoto');
            DOM.retakePhotoBtn = document.getElementById('retakePhotoBtn');
            DOM.submitAttendanceBtn = document.getElementById('submitAttendanceBtn');
            DOM.editPhotoBtn = document.getElementById('editPhotoBtn');
            
            // Photo Metadata Elements
            DOM.metaName = document.getElementById('metaName');
            DOM.metaId = document.getElementById('metaId');
            DOM.metaDepartment = document.getElementById('metaDepartment');
            DOM.metaDateTime = document.getElementById('metaDateTime');
            DOM.metaLocation = document.getElementById('metaLocation');
            DOM.metaVerification = document.getElementById('metaVerification');
            
            // Records Elements
            DOM.dateFrom = document.getElementById('dateFrom');
            DOM.dateTo = document.getElementById('dateTo');
            DOM.filterDepartment = document.getElementById('filterDepartment');
            DOM.searchRecords = document.getElementById('searchRecords');
            DOM.applyFilterBtn = document.getElementById('applyFilterBtn');
            DOM.clearFilterBtn = document.getElementById('clearFilterBtn');
            DOM.recordsContainer = document.getElementById('recordsContainer');
            DOM.exportCsvBtn = document.getElementById('exportCsvBtn');
            DOM.exportPdfBtn = document.getElementById('exportPdfBtn');
            DOM.deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            DOM.syncRecordsBtn = document.getElementById('syncRecordsBtn');
            
            // Map Elements
            DOM.liveMap = document.getElementById('liveMap');
            DOM.liveLat = document.getElementById('liveLat');
            DOM.liveLon = document.getElementById('liveLon');
            DOM.liveSpeed = document.getElementById('liveSpeed');
            DOM.liveHeading = document.getElementById('liveHeading');
            DOM.liveAltitude = document.getElementById('liveAltitude');
            DOM.liveSatellites = document.getElementById('liveSatellites');
            DOM.liveTrackingBtn = document.getElementById('liveTrackingBtn');
            DOM.showHeatmapBtn = document.getElementById('showHeatmapBtn');
            DOM.startLiveTrackingBtn = document.getElementById('startLiveTrackingBtn');
            
            // Analytics Elements
            DOM.analyticsPeriod = document.getElementById('analyticsPeriod');
            DOM.analyticsCharts = document.getElementById('analyticsCharts');
            
            // Settings Elements
            DOM.voiceGuideToggle = document.getElementById('voiceGuideToggle');
            DOM.autoSaveToggle = document.getElementById('autoSaveToggle');
            DOM.gpsAccuracy = document.getElementById('gpsAccuracy');
            DOM.cameraQuality = document.getElementById('cameraQuality');
            DOM.flashMode = document.getElementById('flashMode');
            DOM.frontCameraToggle = document.getElementById('frontCameraToggle');
            DOM.autoBackupToggle = document.getElementById('autoBackupToggle');
            DOM.cloudSyncToggle = document.getElementById('cloudSyncToggle');
            DOM.maxRecords = document.getElementById('maxRecords');
            DOM.backupDataBtn = document.getElementById('backupDataBtn');
            DOM.restoreDataBtn = document.getElementById('restoreDataBtn');
            DOM.clearDataBtn = document.getElementById('clearDataBtn');
            
            // Sidebar Elements
            DOM.statToday = document.getElementById('statToday');
            DOM.statTotal = document.getElementById('statTotal');
            DOM.statMonth = document.getElementById('statMonth');
            DOM.statAccuracy = document.getElementById('statAccuracy');
            DOM.quickMarkBtn = document.getElementById('quickMarkBtn');
            DOM.viewTodayBtn = document.getElementById('viewTodayBtn');
            DOM.exportDataBtn = document.getElementById('exportDataBtn');
            DOM.syncNowBtn = document.getElementById('syncNowBtn');
            DOM.recentActivity = document.getElementById('recentActivity');
            DOM.statusGps = document.getElementById('statusGps');
            DOM.statusCamera = document.getElementById('statusCamera');
            DOM.statusStorage = document.getElementById('statusStorage');
            DOM.statusBattery = document.getElementById('statusBattery');
            
            // FAB Elements
            DOM.mainFab = document.getElementById('mainFab');
            DOM.helpFab = document.getElementById('helpFab');
            DOM.emergencyFab = document.getElementById('emergencyFab');
            
            // Toast Container
            DOM.toastContainer = document.getElementById('toastContainer');
            
            // Modal Container
            DOM.modalContainer = document.getElementById('modalContainer');
            
            // Tour Overlay
            DOM.tourOverlay = document.getElementById('tourOverlay');
        }
        
        // Utility Functions
        const Utils = {
            // Debounce function for performance
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            // Throttle function for performance
            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },
            
            // Format date
            formatDate(date, format = 'full') {
                const d = new Date(date);
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                
                if (format === 'date') {
                    return d.toLocaleDateString('en-IN');
                } else if (format === 'time') {
                    return d.toLocaleTimeString('en-IN');
                } else {
                    return d.toLocaleString('en-IN', options);
                }
            },
            
            // Generate random ID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },
            
            // Validate email
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            // Validate phone
            validatePhone(phone) {
                const re = /^[0-9]{10}$/;
                return re.test(phone);
            },
            
            // Calculate distance between coordinates (in meters)
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Earth's radius in meters
                const 1 = lat1 * Math.PI / 180;
                const 2 = lat2 * Math.PI / 180;
                const  = (lat2 - lat1) * Math.PI / 180;
                const  = (lon2 - lon1) * Math.PI / 180;
                
                const a = Math.sin( / 2) * Math.sin( / 2) +
                          Math.cos(1) * Math.cos(2) *
                          Math.sin( / 2) * Math.sin( / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                
                return R * c;
            },
            
            // Format file size
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },
            
            // Deep clone object
            deepClone(obj) {
                return JSON.parse(JSON.stringify(obj));
            },
            
            // Sleep function
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        };
        
        // Storage Manager
        const Storage = {
            // Save data to localStorage
            save(key, data) {
                try {
                    localStorage.setItem(`smart_attendance_${key}`, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Storage save error:', error);
                    this.showStorageError();
                    return false;
                }
            },
            
            // Load data from localStorage
            load(key) {
                try {
                    const data = localStorage.getItem(`smart_attendance_${key}`);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('Storage load error:', error);
                    return null;
                }
            },
            
            // Remove data from localStorage
            remove(key) {
                try {
                    localStorage.removeItem(`smart_attendance_${key}`);
                    return true;
                } catch (error) {
                    console.error('Storage remove error:', error);
                    return false;
                }
            },
            
            // Clear all app data
            clearAll() {
                try {
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith('smart_attendance_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    return true;
                } catch (error) {
                    console.error('Storage clear error:', error);
                    return false;
                }
            },
            
            // Get storage usage
            getUsage() {
                try {
                    let total = 0;
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith('smart_attendance_')) {
                            total += localStorage.getItem(key).length;
                        }
                    });
                    return total;
                } catch (error) {
                    console.error('Storage usage error:', error);
                    return 0;
                }
            },
            
            // Show storage error message
            showStorageError() {
                Utils.showToast('Storage error! Data may not be saved.', 'error');
            },
            
            // Backup data
            async backup() {
                try {
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        version: CONFIG.VERSION,
                        attendanceRecords: APP_STATE.attendanceRecords,
                        employees: APP_STATE.employees,
                        departments: APP_STATE.departments,
                        settings: APP_STATE.settings
                    };
                    
                    const backupKey = `backup_${Date.now()}`;
                    this.save(backupKey, backupData);
                    
                    // Keep only last 5 backups
                    const backups = this.getBackups();
                    if (backups.length > 5) {
                        backups.slice(5).forEach(backup => {
                            this.remove(backup.key);
                        });
                    }
                    
                    Utils.showToast('Backup created successfully!', 'success');
                    return backupKey;
                } catch (error) {
                    console.error('Backup error:', error);
                    Utils.showToast('Backup failed!', 'error');
                    return null;
                }
            },
            
            // Get all backups
            getBackups() {
                try {
                    const backups = [];
                    const keys = Object.keys(localStorage);
                    
                    keys.forEach(key => {
                        if (key.startsWith('smart_attendance_backup_')) {
                            const data = this.load(key.replace('smart_attendance_', ''));
                            if (data) {
                                backups.push({
                                    key: key.replace('smart_attendance_', ''),
                                    timestamp: data.timestamp,
                                    size: JSON.stringify(data).length
                                });
                            }
                        }
                    });
                    
                    return backups.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                } catch (error) {
                    console.error('Get backups error:', error);
                    return [];
                }
            },
            
            // Restore from backup
            async restore(backupKey) {
                try {
                    const backupData = this.load(backupKey);
                    if (!backupData) {
                        throw new Error('Backup not found');
                    }
                    
                    // Validate backup version
                    if (backupData.version !== CONFIG.VERSION) {
                        if (!confirm(`Backup version (${backupData.version}) differs from current version (${CONFIG.VERSION}). Continue anyway?`)) {
                            return false;
                        }
                    }
                    
                    // Restore data
                    APP_STATE.attendanceRecords = backupData.attendanceRecords || [];
                    APP_STATE.employees = backupData.employees || [];
                    APP_STATE.departments = backupData.departments || [];
                    APP_STATE.settings = { ...APP_STATE.settings, ...backupData.settings };
                    
                    // Save restored data
                    this.save('attendance_records', APP_STATE.attendanceRecords);
                    this.save('employees', APP_STATE.employees);
                    this.save('departments', APP_STATE.departments);
                    this.save('settings', APP_STATE.settings);
                    
                    Utils.showToast('Backup restored successfully!', 'success');
                    return true;
                } catch (error) {
                    console.error('Restore error:', error);
                    Utils.showToast('Restore failed!', 'error');
                    return false;
                }
            }
        };
        
        // Toast Manager
        const Toast = {
            // Show toast notification
            show(message, type = 'info', duration = 5000) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas fa-${this.getIcon(type)}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${this.getTitle(type)}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                `;
                
                DOM.toastContainer.appendChild(toast);
                
                // Show toast
                setTimeout(() => toast.classList.add('show'), 10);
                
                // Auto remove
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, duration);
                
                return toast;
            },
            
            // Get icon based on type
            getIcon(type) {
                switch(type) {
                    case 'success': return 'check-circle';
                    case 'error': return 'exclamation-circle';
                    case 'warning': return 'exclamation-triangle';
                    case 'info': return 'info-circle';
                    default: return 'info-circle';
                }
            },
            
            // Get title based on type
            getTitle(type) {
                switch(type) {
                    case 'success': return 'Success';
                    case 'error': return 'Error';
                    case 'warning': return 'Warning';
                    case 'info': return 'Information';
                    default: return 'Notification';
                }
            },
            
            // Show success toast
            success(message, duration = 5000) {
                return this.show(message, 'success', duration);
            },
            
            // Show error toast
            error(message, duration = 5000) {
                return this.show(message, 'error', duration);
            },
            
            // Show warning toast
            warning(message, duration = 5000) {
                return this.show(message, 'warning', duration);
            },
            
            // Show info toast
            info(message, duration = 5000) {
                return this.show(message, 'info', duration);
            }
        };
        
        // Modal Manager
        const Modal = {
            // Show modal
            show(title, content, buttons = [], options = {}) {
                const modalId = `modal_${Utils.generateId()}`;
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = modalId;
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="Modal.close('${modalId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                        ${buttons.length > 0 ? `
                            <div class="modal-footer">
                                ${buttons.map(btn => `
                                    <button class="btn ${btn.class || 'btn-primary'}" 
                                            onclick="${btn.onclick}">
                                        ${btn.icon ? `<i class="fas fa-${btn.icon}"></i>` : ''}
                                        ${btn.text}
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                DOM.modalContainer.appendChild(modal);
                
                // Show modal
                setTimeout(() => modal.classList.add('show'), 10);
                
                // Handle escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        this.close(modalId);
                    }
                };
                
                modal.dataset.escapeHandler = handleEscape;
                document.addEventListener('keydown', handleEscape);
                
                return modalId;
            },
            
            // Close modal
            close(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        if (modal.parentNode) {
                            const escapeHandler = modal.dataset.escapeHandler;
                            if (escapeHandler) {
                                document.removeEventListener('keydown', escapeHandler);
                            }
                            modal.parentNode.removeChild(modal);
                        }
                    }, 300);
                }
            },
            
            // Show confirmation modal
            confirm(title, message, onConfirm, onCancel = null) {
                return this.show(
                    title,
                    `<p>${message}</p>`,
                    [
                        {
                            text: 'Cancel',
                            class: 'btn-outline-accent',
                            onclick: `Modal.close('${this.currentModalId}'); ${onCancel ? `(${onCancel})()` : ''}`
                        },
                        {
                            text: 'Confirm',
                            class: 'btn-danger',
                            icon: 'check',
                            onclick: `Modal.close('${this.currentModalId}'); (${onConfirm})()`
                        }
                    ]
                );
            },
            
            // Show alert modal
            alert(title, message) {
                return this.show(
                    title,
                    `<p>${message}</p>`,
                    [
                        {
                            text: 'OK',
                            class: 'btn-accent',
                            onclick: `Modal.close('${this.currentModalId}')`
                        }
                    ]
                );
            }
        };
        
        // Voice Guide Manager
        const VoiceGuide = {
            enabled: true,
            voice: null,
            volume: 1,
            rate: 0.9,
            pitch: 1,
            
            // Initialize voice guide
            init() {
                if ('speechSynthesis' in window) {
                    this.voice = window.speechSynthesis;
                    this.enabled = Storage.load('voice_guide_enabled') !== false;
                    
                    // Set default voice
                    this.voice.onvoiceschanged = () => {
                        const voices = this.voice.getVoices();
                        // Prefer English voices
                        const englishVoice = voices.find(v => v.lang.startsWith('en'));
                        if (englishVoice) {
                            this.defaultVoice = englishVoice;
                        }
                    };
                    
                    return true;
                }
                return false;
            },
            
            // Speak text
            speak(text) {
                if (!this.enabled || !this.voice) return;
                
                // Cancel any ongoing speech
                this.voice.cancel();
                
                // Create utterance
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.volume = this.volume;
                utterance.rate = this.rate;
                utterance.pitch = this.pitch;
                
                // Use default voice if available
                if (this.defaultVoice) {
                    utterance.voice = this.defaultVoice;
                }
                
                this.voice.speak(utterance);
            },
            
            // Toggle voice guide
            toggle() {
                this.enabled = !this.enabled;
                Storage.save('voice_guide_enabled', this.enabled);
                
                if (this.enabled) {
                    this.speak('Voice guide enabled');
                    Toast.success('Voice guide enabled');
                } else {
                    Toast.info('Voice guide disabled');
                }
                
                this.updateUI();
            },
            
            // Update UI based on voice guide state
            updateUI() {
                if (DOM.voiceGuideBtn) {
                    if (this.enabled) {
                        DOM.voiceGuideBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                        DOM.voiceGuideBtn.classList.add('active');
                    } else {
                        DOM.voiceGuideBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                        DOM.voiceGuideBtn.classList.remove('active');
                    }
                }
            },
            
            // Guide for specific actions
            guide(action) {
                if (!this.enabled) return;
                
                const messages = {
                    welcome: "Welcome to Smart Attendance System. Please fill your details and mark attendance.",
                    camera_started: "Camera started. Please position your face in the frame.",
                    photo_captured: "Photo captured successfully. You can retake or submit.",
                    location_acquired: "Location acquired. Your attendance will be marked at this location.",
                    attendance_submitted: "Attendance submitted successfully.",
                    gps_lost: "GPS signal lost. Please move to an open area.",
                    offline_mode: "You are offline. Working in offline mode.",
                    online_mode: "Back online. Synchronizing data."
                };
                
                if (messages[action]) {
                    this.speak(messages[action]);
                }
            }
        };
        
        // GPS Manager
        const GPSManager = {
            currentPosition: null,
            watchId: null,
            isTracking: false,
            history: [],
            maxHistory: 100,
            
            // Initialize GPS
            async init() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        DOM.gpsStatus.innerHTML = '<i class="fas fa-times-circle"></i> Not Supported';
                        DOM.gpsStatus.style.color = 'var(--danger-color)';
                        reject(new Error('GPS not supported'));
                        return;
                    }
                    
                    // Request permission and get position
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.handlePosition(position);
                            resolve(position);
                            
                            // Start watching position
                            this.startWatching();
                        },
                        (error) => {
                            this.handleError(error);
                            reject(error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                });
            },
            
            // Start watching position
            startWatching() {
                if (this.watchId) return;
                
                this.watchId = navigator.geolocation.watchPosition(
                    (position) => this.handlePosition(position),
                    (error) => this.handleError(error),
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
                
                this.isTracking = true;
                this.updateUI();
            },
            
            // Stop watching position
            stopWatching() {
                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                    this.isTracking = false;
                    this.updateUI();
                }
            },
            
            // Handle new position
            handlePosition(position) {
                this.currentPosition = position;
                this.history.push({
                    timestamp: new Date().toISOString(),
                    coords: {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude,
                        heading: position.coords.heading,
                        speed: position.coords.speed
                    }
                });
                
                // Keep only recent history
                if (this.history.length > this.maxHistory) {
                    this.history = this.history.slice(-this.maxHistory);
                }
                
                // Update app state
                APP_STATE.currentLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    altitude: position.coords.altitude,
                    heading: position.coords.heading,
                    speed: position.coords.speed,
                    timestamp: new Date().toISOString()
                };
                
                // Update UI
                this.updateUI();
                
                // Update maps
                if (APP_STATE.mainMap) {
                    this.updateMainMap();
                }
                
                if (APP_STATE.liveMap) {
                    this.updateLiveMap();
                }
                
                // Get address
                this.getAddress(position.coords.latitude, position.coords.longitude);
            },
            
            // Handle GPS error
            handleError(error) {
                console.error('GPS Error:', error);
                
                let message = 'Unknown Error';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'Permission Denied';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'Position Unavailable';
                        break;
                    case error.TIMEOUT:
                        message = 'Request Timeout';
                        break;
                }
                
                DOM.gpsStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
                DOM.gpsStatus.style.color = 'var(--warning-color)';
                
                // Try to get IP-based location
                this.getIPLocation();
            },
            
            // Get address from coordinates
            async getAddress(lat, lon) {
                try {
                    const response = await fetch(
                        `${CONFIG.API_ENDPOINTS.GEOCODING}?format=json&lat=${lat}&lon=${lon}&zoom=18`
                    );
                    
                    if (!response.ok) throw new Error('Geocoding failed');
                    
                    const data = await response.json();
                    
                    if (data && data.display_name) {
                        DOM.address.textContent = data.display_name;
                        
                        if (APP_STATE.currentLocation) {
                            APP_STATE.currentLocation.address = data.display_name;
                        }
                    }
                } catch (error) {
                    console.error('Geocoding error:', error);
                    DOM.address.textContent = 'Address not available';
                }
            },
            
            // Get IP-based location
            async getIPLocation() {
                try {
                    const response = await fetch(CONFIG.API_ENDPOINTS.IP_LOCATION);
                    const data = await response.json();
                    
                    if (data) {
                        DOM.coordinates.textContent = `${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}`;
                        DOM.address.textContent = `${data.city}, ${data.region}, ${data.country_name}`;
                        DOM.accuracy.textContent = '5000 meters (IP-based)';
                        
                        APP_STATE.currentLocation = {
                            latitude: data.latitude,
                            longitude: data.longitude,
                            accuracy: 5000,
                            address: `${data.city}, ${data.region}, ${data.country_name}`,
                            source: 'ip'
                        };
                    }
                } catch (error) {
                    console.error('IP location error:', error);
                }
            },
            
            // Update UI with current position
            updateUI() {
                if (!this.currentPosition) return;
                
                const coords = this.currentPosition.coords;
                
                DOM.gpsStatus.innerHTML = '<i class="fas fa-check-circle"></i> Active';
                DOM.gpsStatus.style.color = 'var(--success-color)';
                DOM.coordinates.textContent = `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
                DOM.accuracy.textContent = `${Math.round(coords.accuracy)} meters`;
                
                // Update live map display
                if (DOM.liveLat) DOM.liveLat.textContent = coords.latitude.toFixed(6);
                if (DOM.liveLon) DOM.liveLon.textContent = coords.longitude.toFixed(6);
                if (DOM.liveSpeed) DOM.liveSpeed.textContent = coords.speed ? `${(coords.speed * 3.6).toFixed(1)} km/h` : '0 km/h';
                if (DOM.liveHeading) DOM.liveHeading.textContent = coords.heading ? `${Math.round(coords.heading)}` : '-';
                if (DOM.liveAltitude) DOM.liveAltitude.textContent = coords.altitude ? `${Math.round(coords.altitude)} m` : '-';
                if (DOM.liveSatellites) DOM.liveSatellites.textContent = '-';
                
                // Update status in sidebar
                if (DOM.statusGps) {
                    DOM.statusGps.innerHTML = '<i class="fas fa-circle"></i> Active';
                    DOM.statusGps.className = 'status-value status-active';
                }
            },
            
            // Update main map
            updateMainMap() {
                if (!APP_STATE.mainMap || !this.currentPosition) return;
                
                const lat = this.currentPosition.coords.latitude;
                const lon = this.currentPosition.coords.longitude;
                
                // Clear existing markers
                APP_STATE.mainMap.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        APP_STATE.mainMap.removeLayer(layer);
                    }
                });
                
                // Set view to current location
                APP_STATE.mainMap.setView([lat, lon], 16);
                
                // Add marker
                const marker = L.marker([lat, lon]).addTo(APP_STATE.mainMap);
                marker.bindPopup('<b>Your Current Location</b><br>Attendance will be marked here').openPopup();
                
                // Add accuracy circle
                L.circle([lat, lon], {
                    color: 'var(--accent-color)',
                    fillColor: 'var(--accent-color)',
                    fillOpacity: 0.1,
                    radius: this.currentPosition.coords.accuracy
                }).addTo(APP_STATE.mainMap);
            },
            
            // Update live map
            updateLiveMap() {
                if (!APP_STATE.liveMap || !this.currentPosition) return;
                
                const lat = this.currentPosition.coords.latitude;
                const lon = this.currentPosition.coords.longitude;
                const heading = this.currentPosition.coords.heading || 0;
                
                // Remove existing marker
                if (APP_STATE.userMarker) {
                    APP_STATE.liveMap.removeLayer(APP_STATE.userMarker);
                }
                
                // Create custom icon with direction
                const icon = L.divIcon({
                    className: 'user-marker',
                    html: `<div style="transform: rotate(${heading}deg);">
                             <i class="fas fa-location-arrow" style="font-size: 24px; color: var(--danger-color);"></i>
                           </div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                // Add marker
                APP_STATE.userMarker = L.marker([lat, lon], { icon: icon }).addTo(APP_STATE.liveMap);
                
                // Center map on user
                APP_STATE.liveMap.setView([lat, lon], 16);
                
                // Add accuracy circle
                L.circle([lat, lon], {
                    color: 'var(--danger-color)',
                    fillColor: 'var(--danger-color)',
                    fillOpacity: 0.1,
                    radius: this.currentPosition.coords.accuracy
                }).addTo(APP_STATE.liveMap);
            },
            
            // Get current position
            getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    if (this.currentPosition) {
                        resolve(this.currentPosition);
                    } else {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    }
                });
            },
            
            // Check if location is within accuracy threshold
            isLocationAccurate() {
                if (!this.currentPosition) return false;
                return this.currentPosition.coords.accuracy <= APP_STATE.settings.gpsAccuracy;
            }
        };
        
        // Camera Manager
        const CameraManager = {
            stream: null,
            isActive: false,
            currentCamera: 'user',
            photoCanvas: null,
            photoContext: null,
            
            // Initialize camera
            async init() {
                this.photoCanvas = document.createElement('canvas');
                this.photoContext = this.photoCanvas.getContext('2d');
                
                // Check camera permissions
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    if (videoDevices.length === 0) {
                        throw new Error('No camera found');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Camera initialization error:', error);
                    this.showCameraError(error);
                    return false;
                }
            },
            
            // Start camera
            async start(cameraType = 'user') {
                try {
                    // Stop existing stream
                    await this.stop();
                    
                    // Get camera constraints based on settings
                    const constraints = this.getCameraConstraints(cameraType);
                    
                    // Request camera access
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Set video source
                    DOM.cameraPreview.srcObject = this.stream;
                    DOM.cameraPreview.style.display = 'block';
                    DOM.cameraPlaceholder.style.display = 'none';
                    
                    // Enable capture button
                    DOM.capturePhotoBtn.disabled = false;
                    
                    // Update UI
                    this.isActive = true;
                    this.currentCamera = cameraType;
                    this.updateUI();
                    
                    // Update status
                    if (DOM.statusCamera) {
                        DOM.statusCamera.innerHTML = '<i class="fas fa-circle"></i> Active';
                        DOM.statusCamera.className = 'status-value status-active';
                    }
                    
                    Toast.success('Camera started');
                    VoiceGuide.guide('camera_started');
                    
                    return true;
                } catch (error) {
                    console.error('Camera start error:', error);
                    this.showCameraError(error);
                    return false;
                }
            },
            
            // Stop camera
            async stop() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                this.isActive = false;
                DOM.cameraPreview.style.display = 'none';
                DOM.cameraPlaceholder.style.display = 'flex';
                DOM.capturePhotoBtn.disabled = true;
                
                this.updateUI();
                
                if (DOM.statusCamera) {
                    DOM.statusCamera.innerHTML = '<i class="fas fa-circle"></i> Ready';
                    DOM.statusCamera.className = 'status-value status-inactive';
                }
            },
            
            // Switch camera
            async switchCamera() {
                const newCamera = this.currentCamera === 'user' ? 'environment' : 'user';
                return this.start(newCamera);
            },
            
            // Capture photo
            async capture() {
                if (!this.stream || !this.isActive) {
                    Toast.error('Camera not active');
                    return null;
                }
                
                try {
                    // Set canvas dimensions to match video
                    const video = DOM.cameraPreview;
                    this.photoCanvas.width = video.videoWidth;
                    this.photoCanvas.height = video.videoHeight;
                    
                    // Draw video frame to canvas
                    this.photoContext.save();
                    
                    if (this.currentCamera === 'user') {
                        // Flip horizontally for front camera
                        this.photoContext.translate(this.photoCanvas.width, 0);
                        this.photoContext.scale(-1, 1);
                    }
                    
                    this.photoContext.drawImage(video, 0, 0, this.photoCanvas.width, this.photoCanvas.height);
                    this.photoContext.restore();
                    
                    // Add metadata overlay
                    this.addMetadataOverlay();
                    
                    // Convert to data URL
                    const quality = this.getQualityValue(APP_STATE.settings.cameraQuality);
                    const photoDataUrl = this.photoCanvas.toDataURL('image/jpeg', quality);
                    
                    // Show preview
                    this.showPreview(photoDataUrl);
                    
                    // Save to app state
                    APP_STATE.capturedPhoto = photoDataUrl;
                    
                    Toast.success('Photo captured');
                    VoiceGuide.guide('photo_captured');
                    
                    return photoDataUrl;
                } catch (error) {
                    console.error('Photo capture error:', error);
                    Toast.error('Failed to capture photo');
                    return null;
                }
            },
            
            // Add metadata overlay to photo
            addMetadataOverlay() {
                const ctx = this.photoContext;
                const width = this.photoCanvas.width;
                const height = this.photoCanvas.height;
                
                // Get metadata
                const name = DOM.employeeName.value || 'Unknown';
                const id = DOM.employeeId.value || 'Unknown';
                const department = DOM.department.value || 'Unknown';
                const time = new Date().toLocaleString('en-IN');
                const location = APP_STATE.currentLocation ? 
                    `${APP_STATE.currentLocation.latitude.toFixed(6)}, ${APP_STATE.currentLocation.longitude.toFixed(6)}` : 
                    'Unknown';
                
                // Draw semi-transparent overlay
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, width, 120);
                
                // Set text styles
                ctx.font = 'bold 16px Arial';
                ctx.fillStyle = 'white';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.textBaseline = 'top';
                
                // Draw metadata text
                const metadata = [
                    `Employee: ${name}`,
                    `ID: ${id} | Department: ${department}`,
                    `Time: ${time}`,
                    `Location: ${location}`,
                    `Verified: Smart Attendance System`
                ];
                
                let y = 20;
                metadata.forEach(text => {
                    // Draw text shadow
                    ctx.strokeText(text, 20, y);
                    // Draw text
                    ctx.fillText(text, 20, y);
                    y += 25;
                });
                
                // Draw verification badge
                ctx.fillStyle = 'rgba(0, 176, 155, 0.8)';
                ctx.fillRect(width - 200, 20, 180, 30);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 18px Arial';
                ctx.fillText(' Verified Attendance', width - 195, 32);
            },
            
            // Show photo preview
            showPreview(photoDataUrl) {
                DOM.capturedPhoto.src = photoDataUrl;
                DOM.photoPreview.style.display = 'block';
                
                // Update metadata display
                this.updateMetadataDisplay();
                
                // Scroll to preview
                DOM.photoPreview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            },
            
            // Update metadata display
            updateMetadataDisplay() {
                DOM.metaName.textContent = DOM.employeeName.value || '-';
                DOM.metaId.textContent = DOM.employeeId.value || '-';
                DOM.metaDepartment.textContent = DOM.department.value || '-';
                DOM.metaDateTime.textContent = new Date().toLocaleString('en-IN');
                DOM.metaLocation.textContent = APP_STATE.currentLocation ? 
                    `${APP_STATE.currentLocation.latitude.toFixed(6)}, ${APP_STATE.currentLocation.longitude.toFixed(6)}` : 
                    '-';
                
                // Update verification status
                const isAccurate = GPSManager.isLocationAccurate();
                const verificationBadge = DOM.metaVerification;
                
                if (isAccurate) {
                    verificationBadge.innerHTML = '<i class="fas fa-check-circle"></i> Verified';
                    verificationBadge.className = 'verification-badge';
                } else {
                    verificationBadge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Low Accuracy';
                    verificationBadge.className = 'verification-badge error';
                }
            },
            
            // Get camera constraints
            getCameraConstraints(cameraType) {
                const quality = APP_STATE.settings.cameraQuality;
                
                let videoConstraints = {
                    facingMode: cameraType,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                };
                
                // Adjust based on quality setting
                if (quality === 'low') {
                    videoConstraints = {
                        facingMode: cameraType,
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    };
                } else if (quality === 'high') {
                    videoConstraints = {
                        facingMode: cameraType,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    };
                }
                
                return {
                    video: videoConstraints,
                    audio: false
                };
            },
            
            // Get quality value for JPEG compression
            getQualityValue(quality) {
                switch(quality) {
                    case 'low': return 0.6;
                    case 'medium': return 0.8;
                    case 'high': return 0.95;
                    default: return 0.8;
                }
            },
            
            // Update UI
            updateUI() {
                if (DOM.startCameraBtn) {
                    if (this.isActive) {
                        DOM.startCameraBtn.innerHTML = '<i class="fas fa-stop-circle"></i> Stop Camera';
                        DOM.startCameraBtn.className = 'btn btn-danger';
                    } else {
                        DOM.startCameraBtn.innerHTML = '<i class="fas fa-video"></i> Start Camera';
                        DOM.startCameraBtn.className = 'btn btn-accent';
                    }
                }
            },
            
            // Show camera error
            showCameraError(error) {
                let message = 'Camera error occurred';
                
                if (error.name === 'NotAllowedError') {
                    message = 'Camera access denied. Please allow camera access in browser settings.';
                } else if (error.name === 'NotFoundError') {
                    message = 'No camera found on this device.';
                } else if (error.name === 'NotReadableError') {
                    message = 'Camera is in use by another application.';
                }
                
                Toast.error(message);
                
                // Update placeholder
                DOM.cameraPlaceholder.innerHTML = `
                    <i class="fas fa-video-slash" style="font-size: 4rem; margin-bottom: 20px;"></i>
                    <p>${message}</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">Using demo mode</p>
                `;
            }
        };
        
        // Attendance Manager
        const AttendanceManager = {
            // Submit attendance
            async submit() {
                try {
                    // Validate inputs
                    if (!this.validateForm()) {
                        return false;
                    }
                    
                    // Check location accuracy
                    if (!GPSManager.isLocationAccurate()) {
                        const proceed = confirm('Location accuracy is low. Do you want to submit anyway?');
                        if (!proceed) {
                            return false;
                        }
                    }
                    
                    // Check if photo is captured
                    if (!APP_STATE.capturedPhoto) {
                        Toast.error('Please capture a photo first');
                        return false;
                    }
                    
                    // Create attendance record
                    const record = this.createRecord();
                    
                    // Add to records
                    APP_STATE.attendanceRecords.unshift(record);
                    
                    // Save to storage
                    Storage.save('attendance_records', APP_STATE.attendanceRecords);
                    
                    // Reset form
                    this.resetForm();
                    
                    // Update UI
                    this.updateStats();
                    this.updateBadges();
                    
                    // Show success message
                    Toast.success(`Attendance recorded for ${record.employeeName}`);
                    VoiceGuide.guide('attendance_submitted');
                    
                    // Add to recent activity
                    this.addRecentActivity(record);
                    
                    return true;
                } catch (error) {
                    console.error('Attendance submission error:', error);
                    Toast.error('Failed to submit attendance');
                    return false;
                }
            },
            
            // Validate form inputs
            validateForm() {
                const name = DOM.employeeName.value.trim();
                const id = DOM.employeeId.value.trim();
                const department = DOM.department.value.trim();
                
                let isValid = true;
                let errors = [];
                
                // Validate name
                if (!name) {
                    errors.push('Employee name is required');
                    DOM.employeeName.classList.add('error');
                    isValid = false;
                } else {
                    DOM.employeeName.classList.remove('error');
                }
                
                // Validate ID
                if (!id) {
                    errors.push('Employee ID is required');
                    DOM.employeeId.classList.add('error');
                    isValid = false;
                } else {
                    DOM.employeeId.classList.remove('error');
                }
                
                // Validate department
                if (!department) {
                    errors.push('Department is required');
                    DOM.department.classList.add('error');
                    isValid = false;
                } else {
                    DOM.department.classList.remove('error');
                }
                
                // Show errors if any
                if (errors.length > 0) {
                    Toast.error(errors.join('<br>'));
                }
                
                return isValid;
            },
            
            // Create attendance record
            createRecord() {
                return {
                    id: Utils.generateId(),
                    employeeName: DOM.employeeName.value.trim(),
                    employeeId: DOM.employeeId.value.trim(),
                    department: DOM.department.value.trim(),
                    designation: DOM.designation.value.trim(),
                    photo: APP_STATE.capturedPhoto,
                    location: APP_STATE.currentLocation ? {
                        latitude: APP_STATE.currentLocation.latitude,
                        longitude: APP_STATE.currentLocation.longitude,
                        accuracy: APP_STATE.currentLocation.accuracy,
                        address: APP_STATE.currentLocation.address
                    } : null,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('en-IN'),
                    time: new Date().toLocaleTimeString('en-IN'),
                    verified: GPSManager.isLocationAccurate(),
                    source: 'web_app',
                    version: CONFIG.VERSION
                };
            },
            
            // Reset form
            resetForm() {
                // Hide photo preview
                DOM.photoPreview.style.display = 'none';
                
                // Clear captured photo
                APP_STATE.capturedPhoto = null;
                
                // Stop camera
                CameraManager.stop();
                
                // Keep form values for quick marking
                // Optionally clear form:
                // DOM.employeeName.value = '';
                // DOM.employeeId.value = '';
                // DOM.department.value = '';
                // DOM.designation.value = '';
            },
            
            // Load records
            loadRecords(filters = {}) {
                let records = APP_STATE.attendanceRecords;
                
                // Apply filters
                if (filters.dateFrom) {
                    const fromDate = new Date(filters.dateFrom);
                    records = records.filter(record => new Date(record.timestamp) >= fromDate);
                }
                
                if (filters.dateTo) {
                    const toDate = new Date(filters.dateTo);
                    records = records.filter(record => new Date(record.timestamp) <= toDate);
                }
                
                if (filters.department) {
                    records = records.filter(record => record.department === filters.department);
                }
                
                if (filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    records = records.filter(record => 
                        record.employeeName.toLowerCase().includes(searchTerm) ||
                        record.employeeId.toLowerCase().includes(searchTerm) ||
                        record.department.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Display records
                this.displayRecords(records);
                
                return records;
            },
            
            // Display records in UI
            displayRecords(records) {
                const container = DOM.recordsContainer;
                
                if (records.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard"></i>
                            <h3>No Records Found</h3>
                            <p>Try changing your filters</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                records.forEach(record => {
                    const isSelected = APP_STATE.selectedRecords.has(record.id);
                    const initials = record.employeeName.split(' ').map(n => n[0]).join('').toUpperCase();
                    
                    html += `
                        <div class="record-card ${isSelected ? 'selected' : ''}" data-id="${record.id}">
                            <div class="record-header">
                                <div class="record-employee">
                                    <div class="record-avatar">
                                        ${initials.substring(0, 2)}
                                    </div>
                                    <div class="record-info">
                                        <h4>${record.employeeName}</h4>
                                        <div class="record-department">
                                            <i class="fas fa-building"></i>
                                            ${record.department}
                                        </div>
                                    </div>
                                </div>
                                <div class="record-time">
                                    ${record.time}
                                </div>
                            </div>
                            <div class="record-details">
                                <div class="record-detail">
                                    <span class="record-label">Employee ID</span>
                                    <span class="record-value">${record.employeeId}</span>
                                </div>
                                <div class="record-detail">
                                    <span class="record-label">Location</span>
                                    <span class="record-value">${record.location ? record.location.address || 'Unknown' : 'Unknown'}</span>
                                </div>
                                <div class="record-detail">
                                    <span class="record-label">Accuracy</span>
                                    <span class="record-value">${record.location ? Math.round(record.location.accuracy) + ' m' : 'N/A'}</span>
                                </div>
                                <div class="record-detail">
                                    <span class="record-label">Status</span>
                                    <span class="record-value">
                                        <span class="verification-badge ${record.verified ? '' : 'error'}">
                                            <i class="fas fa-${record.verified ? 'check-circle' : 'exclamation-triangle'}"></i>
                                            ${record.verified ? 'Verified' : 'Low Accuracy'}
                                        </span>
                                    </span>
                                </div>
                            </div>
                            <div class="record-actions">
                                <button class="action-btn" onclick="AttendanceManager.viewRecord('${record.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn" onclick="AttendanceManager.deleteRecord('${record.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Add click handlers for selection
                container.querySelectorAll('.record-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('.action-btn')) {
                            const recordId = card.dataset.id;
                            this.toggleRecordSelection(recordId);
                        }
                    });
                });
            },
            
            // Toggle record selection
            toggleRecordSelection(recordId) {
                if (APP_STATE.selectedRecords.has(recordId)) {
                    APP_STATE.selectedRecords.delete(recordId);
                } else {
                    APP_STATE.selectedRecords.add(recordId);
                }
                
                // Update UI
                const card = document.querySelector(`.record-card[data-id="${recordId}"]`);
                if (card) {
                    card.classList.toggle('selected');
                }
            },
            
            // Delete record
            deleteRecord(recordId) {
                Modal.confirm(
                    'Delete Record',
                    'Are you sure you want to delete this attendance record? This action cannot be undone.',
                    () => {
                        APP_STATE.attendanceRecords = APP_STATE.attendanceRecords.filter(r => r.id !== recordId);
                        Storage.save('attendance_records', APP_STATE.attendanceRecords);
                        
                        APP_STATE.selectedRecords.delete(recordId);
                        
                        // Reload records
                        this.loadRecords(APP_STATE.filters);
                        
                        // Update stats
                        this.updateStats();
                        this.updateBadges();
                        
                        Toast.success('Record deleted');
                    }
                );
            },
            
            // View record details
            viewRecord(recordId) {
                const record = APP_STATE.attendanceRecords.find(r => r.id === recordId);
                if (!record) return;
                
                Modal.show(
                    `Attendance Details - ${record.employeeName}`,
                    `
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--accent-gradient); 
                                     display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    ${record.employeeName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}
                                </div>
                                <div>
                                    <h4 style="margin: 0 0 5px 0;">${record.employeeName}</h4>
                                    <p style="margin: 0; color: var(--text-secondary);">
                                        ${record.employeeId} | ${record.department}
                                    </p>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <small style="color: var(--text-secondary);">Date</small>
                                    <p style="margin: 5px 0; font-weight: 500;">${record.date}</p>
                                </div>
                                <div>
                                    <small style="color: var(--text-secondary);">Time</small>
                                    <p style="margin: 5px 0; font-weight: 500;">${record.time}</p>
                                </div>
                                <div>
                                    <small style="color: var(--text-secondary);">Location Accuracy</small>
                                    <p style="margin: 5px 0; font-weight: 500;">${record.location ? Math.round(record.location.accuracy) + ' m' : 'N/A'}</p>
                                </div>
                                <div>
                                    <small style="color: var(--text-secondary);">Verification</small>
                                    <p style="margin: 5px 0;">
                                        <span class="verification-badge ${record.verified ? '' : 'error'}">
                                            <i class="fas fa-${record.verified ? 'check-circle' : 'exclamation-triangle'}"></i>
                                            ${record.verified ? 'Verified' : 'Low Accuracy'}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            
                            ${record.location && record.location.address ? `
                                <div>
                                    <small style="color: var(--text-secondary);">Address</small>
                                    <p style="margin: 5px 0; font-weight: 500;">${record.location.address}</p>
                                </div>
                            ` : ''}
                            
                            <div>
                                <small style="color: var(--text-secondary);">Photo</small>
                                <div style="margin-top: 10px;">
                                    <img src="${record.photo}" alt="Attendance Photo" 
                                         style="width: 100%; border-radius: var(--border-radius-md);">
                                </div>
                            </div>
                        </div>
                    `,
                    [
                        {
                            text: 'Close',
                            class: 'btn-outline-accent',
                            onclick: `Modal.close('${Modal.currentModalId}')`
                        }
                    ]
                );
            },
            
            // Export records as CSV
            exportCSV(records = null) {
                const data = records || APP_STATE.attendanceRecords;
                
                if (data.length === 0) {
                    Toast.error('No records to export');
                    return;
                }
                
                const headers = ['Date', 'Time', 'Employee Name', 'Employee ID', 'Department', 
                               'Latitude', 'Longitude', 'Accuracy', 'Address', 'Verified'];
                
                const csvRows = [
                    headers.join(','),
                    ...data.map(record => [
                        `"${record.date}"`,
                        `"${record.time}"`,
                        `"${record.employeeName}"`,
                        `"${record.employeeId}"`,
                        `"${record.department}"`,
                        record.location ? record.location.latitude : '',
                        record.location ? record.location.longitude : '',
                        record.location ? record.location.accuracy : '',
                        `"${record.location ? record.location.address || '' : ''}"`,
                        record.verified ? 'Yes' : 'No'
                    ].join(','))
                ];
                
                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `attendance_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                Toast.success('Data exported as CSV');
            },
            
            // Export records as PDF
            async exportPDF(records = null) {
                const data = records || APP_STATE.attendanceRecords;
                
                if (data.length === 0) {
                    Toast.error('No records to export');
                    return;
                }
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Add title
                    doc.setFontSize(20);
                    doc.text('Attendance Records', 20, 20);
                    
                    // Add date
                    doc.setFontSize(12);
                    doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 20, 30);
                    
                    // Create table
                    const headers = [['Date', 'Time', 'Name', 'ID', 'Department', 'Verified']];
                    const tableData = data.map(record => [
                        record.date,
                        record.time,
                        record.employeeName.substring(0, 20),
                        record.employeeId,
                        record.department.substring(0, 15),
                        record.verified ? 'Yes' : 'No'
                    ]);
                    
                    doc.autoTable({
                        head: headers,
                        body: tableData,
                        startY: 40,
                        theme: 'grid',
                        headStyles: { fillColor: [15, 52, 96] },
                        alternateRowStyles: { fillColor: [240, 240, 240] }
                    });
                    
                    // Save PDF
                    doc.save(`attendance_${new Date().toISOString().split('T')[0]}.pdf`);
                    
                    Toast.success('Data exported as PDF');
                } catch (error) {
                    console.error('PDF export error:', error);
                    Toast.error('Failed to export PDF');
                }
            },
            
            // Update statistics
            updateStats() {
                const today = new Date().toLocaleDateString('en-IN');
                const todayRecords = APP_STATE.attendanceRecords.filter(r => r.date === today);
                const thisMonth = new Date().getMonth();
                const thisMonthRecords = APP_STATE.attendanceRecords.filter(r => new Date(r.timestamp).getMonth() === thisMonth);
                
                DOM.statToday.textContent = todayRecords.length;
                DOM.statTotal.textContent = APP_STATE.attendanceRecords.length;
                DOM.statMonth.textContent = thisMonthRecords.length;
                
                // Calculate average accuracy
                const validRecords = APP_STATE.attendanceRecords.filter(r => r.location && r.location.accuracy);
                if (validRecords.length > 0) {
                    const avgAccuracy = Math.round(validRecords.reduce((sum, r) => sum + r.location.accuracy, 0) / validRecords.length);
                    DOM.statAccuracy.textContent = `${avgAccuracy}m`;
                } else {
                    DOM.statAccuracy.textContent = '0m';
                }
            },
            
            // Update badges
            updateBadges() {
                const today = new Date().toLocaleDateString('en-IN');
                const todayRecords = APP_STATE.attendanceRecords.filter(r => r.date === today);
                
                DOM.attendanceBadge.textContent = todayRecords.length;
                DOM.recordsBadge.textContent = APP_STATE.attendanceRecords.length;
            },
            
            // Add recent activity
            addRecentActivity(record) {
                const activity = {
                    id: Utils.generateId(),
                    type: 'attendance',
                    message: `Attendance marked for ${record.employeeName}`,
                    timestamp: new Date().toISOString(),
                    icon: 'fa-user-check',
                    color: 'var(--success-color)'
                };
                
                APP_STATE.recentActivity.unshift(activity);
                
                // Keep only last 5 activities
                if (APP_STATE.recentActivity.length > 5) {
                    APP_STATE.recentActivity = APP_STATE.recentActivity.slice(0, 5);
                }
                
                // Update UI
                this.updateRecentActivity();
            },
            
            // Update recent activity display
            updateRecentActivity() {
                const container = DOM.recentActivity;
                
                if (APP_STATE.recentActivity.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px 0;">
                            <i class="fas fa-history"></i>
                            <p>No recent activity</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                APP_STATE.recentActivity.forEach(activity => {
                    const time = Utils.formatDate(activity.timestamp, 'time');
                    
                    html += `
                        <div class="activity-item" style="display: flex; align-items: center; gap: 10px; padding: 10px; 
                              border-bottom: 1px solid var(--border-color);">
                            <div style="width: 30px; height: 30px; border-radius: 50%; background: ${activity.color}; 
                                 display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fas ${activity.icon}"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.9rem;">${activity.message}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${time}</div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        };
        
        // Map Manager
        const MapManager = {
            // Initialize main map
            initMainMap() {
                if (!DOM.map) return;
                
                // Create map centered on India by default
                APP_STATE.mainMap = L.map('map').setView([20.5937, 78.9629], 5);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(APP_STATE.mainMap);
                
                // Add scale
                L.control.scale().addTo(APP_STATE.mainMap);
                
                // Update with current location
                if (APP_STATE.currentLocation) {
                    GPSManager.updateMainMap();
                }
            },
            
            // Initialize live map
            initLiveMap() {
                if (!DOM.liveMap) return;
                
                // Create map centered on India by default
                APP_STATE.liveMap = L.map('liveMap').setView([20.5937, 78.9629], 5);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(APP_STATE.liveMap);
                
                // Add scale
                L.control.scale().addTo(APP_STATE.liveMap);
                
                // Add fullscreen control
                APP_STATE.liveMap.addControl(new L.Control.Fullscreen());
                
                // Update with current location
                if (APP_STATE.currentLocation) {
                    GPSManager.updateLiveMap();
                }
            },
            
            // Start live tracking
            startLiveTracking() {
                if (APP_STATE.trackingInterval) {
                    clearInterval(APP_STATE.trackingInterval);
                }
                
                APP_STATE.trackingInterval = setInterval(() => {
                    if (APP_STATE.currentLocation && APP_STATE.liveMap) {
                        GPSManager.updateLiveMap();
                    }
                }, 3000); // Update every 3 seconds
                
                DOM.startLiveTrackingBtn.innerHTML = '<i class="fas fa-stop-circle"></i> Stop Live Tracking';
                DOM.startLiveTrackingBtn.classList.remove('btn-accent');
                DOM.startLiveTrackingBtn.classList.add('btn-danger');
                
                Toast.success('Live tracking started');
            },
            
            // Stop live tracking
            stopLiveTracking() {
                if (APP_STATE.trackingInterval) {
                    clearInterval(APP_STATE.trackingInterval);
                    APP_STATE.trackingInterval = null;
                }
                
                DOM.startLiveTrackingBtn.innerHTML = '<i class="fas fa-play-circle"></i> Start Live Tracking';
                DOM.startLiveTrackingBtn.classList.remove('btn-danger');
                DOM.startLiveTrackingBtn.classList.add('btn-accent');
                
                Toast.info('Live tracking stopped');
            },
            
            // Toggle live tracking
            toggleLiveTracking() {
                if (APP_STATE.trackingInterval) {
                    this.stopLiveTracking();
                } else {
                    this.startLiveTracking();
                }
            }
        };
        
        // Analytics Manager
        const AnalyticsManager = {
            // Initialize analytics
            init() {
                this.updateAnalytics();
            },
            
            // Update analytics
            updateAnalytics() {
                const period = DOM.analyticsPeriod.value;
                let filteredRecords = [];
                
                // Filter records based on period
                const now = new Date();
                switch(period) {
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        filteredRecords = APP_STATE.attendanceRecords.filter(r => new Date(r.timestamp) >= weekAgo);
                        break;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        filteredRecords = APP_STATE.attendanceRecords.filter(r => new Date(r.timestamp) >= monthAgo);
                        break;
                    case 'quarter':
                        const quarterAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                        filteredRecords = APP_STATE.attendanceRecords.filter(r => new Date(r.timestamp) >= quarterAgo);
                        break;
                    case 'year':
                        const yearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                        filteredRecords = APP_STATE.attendanceRecords.filter(r => new Date(r.timestamp) >= yearAgo);
                        break;
                    default:
                        filteredRecords = APP_STATE.attendanceRecords;
                }
                
                // Group by department
                const deptData = {};
                filteredRecords.forEach(record => {
                    if (!deptData[record.department]) {
                        deptData[record.department] = 0;
                    }
                    deptData[record.department]++;
                });
                
                // Group by date
                const dateData = {};
                filteredRecords.forEach(record => {
                    const date = record.date;
                    if (!dateData[date]) {
                        dateData[date] = 0;
                    }
                    dateData[date]++;
                });
                
                // Update charts
                this.createDepartmentChart(deptData);
                this.createDailyChart(dateData);
            },
            
            // Create department chart
            createDepartmentChart(deptData) {
                const canvas = document.createElement('canvas');
                canvas.id = 'deptChart';
                canvas.width = 400;
                canvas.height = 300;
                
                // Clear existing chart
                const existingChart = APP_STATE.charts.deptChart;
                if (existingChart) {
                    existingChart.destroy();
                }
                
                // Prepare data
                const labels = Object.keys(deptData);
                const data = Object.values(deptData);
                const colors = this.generateColors(labels.length);
                
                // Create chart
                const ctx = canvas.getContext('2d');
                APP_STATE.charts.deptChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: 'white',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: true,
                                text: 'Attendance by Department'
                            }
                        }
                    }
                });
                
                // Add to container
                DOM.analyticsCharts.innerHTML = '';
                DOM.analyticsCharts.appendChild(canvas);
            },
            
            // Create daily chart
            createDailyChart(dateData) {
                const canvas = document.createElement('canvas');
                canvas.id = 'dailyChart';
                canvas.width = 400;
                canvas.height = 300;
                
                // Clear existing chart
                const existingChart = APP_STATE.charts.dailyChart;
                if (existingChart) {
                    existingChart.destroy();
                }
                
                // Sort dates
                const sortedDates = Object.keys(dateData).sort();
                const sortedData = sortedDates.map(date => dateData[date]);
                
                // Create chart
                const ctx = canvas.getContext('2d');
                APP_STATE.charts.dailyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Daily Attendance',
                            data: sortedData,
                            backgroundColor: 'rgba(255, 154, 0, 0.2)',
                            borderColor: 'rgba(255, 154, 0, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Daily Attendance Trend'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Records'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        }
                    }
                });
                
                // Add to container
                DOM.analyticsCharts.appendChild(canvas);
            },
            
            // Generate colors for charts
            generateColors(count) {
                const colors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ];
                
                return colors.slice(0, count);
            }
        };
        
        // Settings Manager
        const SettingsManager = {
            // Load settings
            loadSettings() {
                const savedSettings = Storage.load('settings');
                if (savedSettings) {
                    APP_STATE.settings = { ...APP_STATE.settings, ...savedSettings };
                }
                
                // Update UI
                this.updateSettingsUI();
            },
            
            // Save settings
            saveSettings() {
                Storage.save('settings', APP_STATE.settings);
                Toast.success('Settings saved');
            },
            
            // Update settings UI
            updateSettingsUI() {
                // Voice guide
                DOM.voiceGuideToggle.checked = APP_STATE.settings.voiceGuide;
                
                // Auto save
                DOM.autoSaveToggle.checked = APP_STATE.settings.autoSave;
                
                // GPS accuracy
                DOM.gpsAccuracy.value = APP_STATE.settings.gpsAccuracy;
                
                // Camera quality
                DOM.cameraQuality.value = APP_STATE.settings.cameraQuality;
                
                // Flash mode
                DOM.flashMode.value = APP_STATE.settings.flashMode;
                
                // Front camera
                DOM.frontCameraToggle.checked = APP_STATE.settings.frontCamera;
                
                // Auto backup
                DOM.autoBackupToggle.checked = APP_STATE.settings.autoBackup;
                
                // Cloud sync
                DOM.cloudSyncToggle.checked = APP_STATE.settings.cloudSync;
                
                // Max records
                DOM.maxRecords.value = APP_STATE.settings.maxRecords;
            },
            
            // Apply settings from UI
            applySettings() {
                // Voice guide
                APP_STATE.settings.voiceGuide = DOM.voiceGuideToggle.checked;
                VoiceGuide.enabled = APP_STATE.settings.voiceGuide;
                VoiceGuide.updateUI();
                
                // Auto save
                APP_STATE.settings.autoSave = DOM.autoSaveToggle.checked;
                
                // GPS accuracy
                APP_STATE.settings.gpsAccuracy = parseInt(DOM.gpsAccuracy.value);
                
                // Camera quality
                APP_STATE.settings.cameraQuality = DOM.cameraQuality.value;
                
                // Flash mode
                APP_STATE.settings.flashMode = DOM.flashMode.value;
                
                // Front camera
                APP_STATE.settings.frontCamera = DOM.frontCameraToggle.checked;
                
                // Auto backup
                APP_STATE.settings.autoBackup = DOM.autoBackupToggle.checked;
                
                // Cloud sync
                APP_STATE.settings.cloudSync = DOM.cloudSyncToggle.checked;
                
                // Max records
                APP_STATE.settings.maxRecords = DOM.maxRecords.value;
                
                // Save settings
                this.saveSettings();
            }
        };
        
        // Event Handlers
        const EventHandlers = {
            // Initialize all event handlers
            init() {
                // Tab switching
                DOM.tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tab = btn.dataset.tab;
                        this.switchTab(tab);
                    });
                });
                
                // Voice guide toggle
                DOM.voiceGuideBtn.addEventListener('click', () => {
                    VoiceGuide.toggle();
                });
                
                // Theme toggle
                DOM.themeToggle.addEventListener('click', () => {
                    this.toggleTheme();
                });
                
                // Help button
                DOM.helpBtn.addEventListener('click', () => {
                    this.showHelp();
                });
                
                // Refresh location
                DOM.refreshLocationBtn.addEventListener('click', () => {
                    GPSManager.init();
                });
                
                // Camera controls
                DOM.startCameraBtn.addEventListener('click', () => {
                    if (CameraManager.isActive) {
                        CameraManager.stop();
                    } else {
                        CameraManager.start(APP_STATE.settings.frontCamera ? 'user' : 'environment');
                    }
                });
                
                DOM.capturePhotoBtn.addEventListener('click', () => {
                    CameraManager.capture();
                });
                
                DOM.switchCameraBtn.addEventListener('click', () => {
                    CameraManager.switchCamera();
                });
                
                // Photo preview controls
                DOM.retakePhotoBtn.addEventListener('click', () => {
                    DOM.photoPreview.style.display = 'none';
                    APP_STATE.capturedPhoto = null;
                });
                
                DOM.submitAttendanceBtn.addEventListener('click', () => {
                    AttendanceManager.submit();
                });
                
                // Records filter
                DOM.applyFilterBtn.addEventListener('click', () => {
                    APP_STATE.filters = {
                        dateFrom: DOM.dateFrom.value,
                        dateTo: DOM.dateTo.value,
                        department: DOM.filterDepartment.value,
                        search: DOM.searchRecords.value
                    };
                    
                    AttendanceManager.loadRecords(APP_STATE.filters);
                });
                
                DOM.clearFilterBtn.addEventListener('click', () => {
                    DOM.dateFrom.value = '';
                    DOM.dateTo.value = '';
                    DOM.filterDepartment.value = '';
                    DOM.searchRecords.value = '';
                    
                    APP_STATE.filters = {};
                    AttendanceManager.loadRecords();
                });
                
                // Export buttons
                DOM.exportCsvBtn.addEventListener('click', () => {
                    AttendanceManager.exportCSV();
                });
                
                DOM.exportPdfBtn.addEventListener('click', () => {
                    AttendanceManager.exportPDF();
                });
                
                DOM.deleteSelectedBtn.addEventListener('click', () => {
                    this.deleteSelectedRecords();
                });
                
                // Map controls
                DOM.startLiveTrackingBtn.addEventListener('click', () => {
                    MapManager.toggleLiveTracking();
                });
                
                // Analytics period change
                DOM.analyticsPeriod.addEventListener('change', () => {
                    AnalyticsManager.updateAnalytics();
                });
                
                // Settings controls
                DOM.voiceGuideToggle.addEventListener('change', () => {
                    SettingsManager.applySettings();
                });
                
                DOM.autoSaveToggle.addEventListener('change', () => {
                    SettingsManager.applySettings();
                });
                
                DOM.gpsAccuracy.addEventListener('change', () => {
                    SettingsManager.applySettings();
                });
                
                DOM.cameraQuality.addEventListener('change', () => {
                    SettingsManager.applySettings();
                });
                
                DOM.flashMode.addEventListener('change', () => {
                    SettingsManager.applySettings();
                });
                
                DOM.frontCameraToggle.addEventListener('change', () => {
                    SettingsManager.applySettings();
                });
                
                DOM.autoBackupToggle.addEventListener('change', () => {
                    SettingsManager.applySettings();
                });
                
                DOM.cloudSyncToggle.addEventListener('change', () => {
                    SettingsManager.applySettings();
                });
                
                DOM.maxRecords.addEventListener('change', () => {
                    SettingsManager.applySettings();
                });
                
                // Backup buttons
                DOM.backupDataBtn.addEventListener('click', () => {
                    Storage.backup();
                });
                
                DOM.restoreDataBtn.addEventListener('click', () => {
                    this.showRestoreDialog();
                });
                
                DOM.clearDataBtn.addEventListener('click', () => {
                    this.confirmClearData();
                });
                
                // Quick action buttons
                DOM.quickMarkBtn.addEventListener('click', () => {
                    this.switchTab('attendance');
                    VoiceGuide.guide('welcome');
                });
                
                DOM.viewTodayBtn.addEventListener('click', () => {
                    this.switchTab('records');
                    DOM.dateFrom.value = new Date().toISOString().split('T')[0];
                    DOM.dateTo.value = new Date().toISOString().split('T')[0];
                    DOM.applyFilterBtn.click();
                });
                
                DOM.exportDataBtn.addEventListener('click', () => {
                    AttendanceManager.exportCSV();
                });
                
                DOM.syncNowBtn.addEventListener('click', () => {
                    Toast.info('Syncing data...');
                    // Simulate sync
                    setTimeout(() => {
                        Toast.success('Data synced successfully');
                    }, 2000);
                });
                
                // FAB buttons
                DOM.mainFab.addEventListener('click', () => {
                    this.showQuickActions();
                });
                
                DOM.helpFab.addEventListener('click', () => {
                    this.showHelp();
                });
                
                DOM.emergencyFab.addEventListener('click', () => {
                    this.showEmergencyOptions();
                });
                
                // Employee name autocomplete
                DOM.employeeName.addEventListener('input', Utils.debounce(() => {
                    this.handleNameAutocomplete();
                }, 300));
                
                // Scan ID button
                DOM.scanIdBtn.addEventListener('click', () => {
                    this.showQRScanner();
                });
                
                // Sync records button
                DOM.syncRecordsBtn.addEventListener('click', () => {
                    Toast.info('Syncing records...');
                    // Simulate sync
                    setTimeout(() => {
                        Toast.success('Records synced successfully');
                    }, 2000);
                });
                
                // Live tracking button
                DOM.liveTrackingBtn.addEventListener('click', () => {
                    MapManager.toggleLiveTracking();
                });
                
                // Heatmap button
                DOM.showHeatmapBtn.addEventListener('click', () => {
                    Toast.info('Heatmap feature coming soon!');
                });
            },
            
            // Switch tab
            switchTab(tabName) {
                // Update active tab button
                DOM.tabBtns.forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Update active tab pane
                DOM.tabPanes.forEach(pane => {
                    if (pane.id === `${tabName}Tab`) {
                        pane.classList.add('active');
                        
                        // Initialize specific tab content
                        switch(tabName) {
                            case 'map':
                                if (!APP_STATE.liveMap) {
                                    MapManager.initLiveMap();
                                }
                                break;
                            case 'analytics':
                                AnalyticsManager.updateAnalytics();
                                break;
                        }
                    } else {
                        pane.classList.remove('active');
                    }
                });
                
                APP_STATE.activeTab = tabName;
            },
            
            // Toggle theme
            toggleTheme() {
                APP_STATE.isDarkMode = !APP_STATE.isDarkMode;
                
                if (APP_STATE.isDarkMode) {
                    document.body.classList.add('dark-mode');
                    DOM.themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    document.body.classList.remove('dark-mode');
                    DOM.themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                }
                
                Toast.info(`Theme switched to ${APP_STATE.isDarkMode ? 'dark' : 'light'} mode`);
            },
            
            // Show help
            showHelp() {
                Modal.show(
                    'Help & Tutorial',
                    `
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            <div>
                                <h4>How to Mark Attendance:</h4>
                                <ol style="margin-left: 20px;">
                                    <li>Fill in employee details (Name, ID, Department)</li>
                                    <li>Wait for GPS location to be acquired</li>
                                    <li>Start camera and capture photo</li>
                                    <li>Review photo and metadata</li>
                                    <li>Submit attendance</li>
                                </ol>
                            </div>
                            
                            <div>
                                <h4>Features:</h4>
                                <ul style="margin-left: 20px;">
                                    <li><strong>GPS Verification:</strong> Ensures attendance is marked from authorized locations</li>
                                    <li><strong>Photo Capture:</strong> Takes timestamped, geotagged photos</li>
                                    <li><strong>Live Tracking:</strong> Real-time GPS tracking on map</li>
                                    <li><strong>Analytics:</strong> Visual reports and statistics</li>
                                    <li><strong>Export Data:</strong> Export records as CSV or PDF</li>
                                </ul>
                            </div>
                            
                            <div>
                                <h4>Tips:</h4>
                                <ul style="margin-left: 20px;">
                                    <li>Ensure GPS is enabled for accurate location</li>
                                    <li>Use good lighting for clear photos</li>
                                    <li>Regularly backup your data</li>
                                    <li>Export records periodically</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    [
                        {
                            text: 'Close',
                            class: 'btn-accent',
                            onclick: `Modal.close('${Modal.currentModalId}')`
                        }
                    ]
                );
            },
            
            // Delete selected records
            deleteSelectedRecords() {
                if (APP_STATE.selectedRecords.size === 0) {
                    Toast.error('No records selected');
                    return;
                }
                
                Modal.confirm(
                    'Delete Selected Records',
                    `Are you sure you want to delete ${APP_STATE.selectedRecords.size} selected record(s)? This action cannot be undone.`,
                    () => {
                        APP_STATE.attendanceRecords = APP_STATE.attendanceRecords.filter(
                            r => !APP_STATE.selectedRecords.has(r.id)
                        );
                        
                        Storage.save('attendance_records', APP_STATE.attendanceRecords);
                        APP_STATE.selectedRecords.clear();
                        
                        AttendanceManager.loadRecords(APP_STATE.filters);
                        AttendanceManager.updateStats();
                        AttendanceManager.updateBadges();
                        
                        Toast.success(`${APP_STATE.selectedRecords.size} records deleted`);
                    }
                );
            },
            
            // Show restore dialog
            showRestoreDialog() {
                const backups = Storage.getBackups();
                
                if (backups.length === 0) {
                    Toast.error('No backups found');
                    return;
                }
                
                let backupList = '';
                backups.forEach(backup => {
                    const date = new Date(backup.timestamp).toLocaleString('en-IN');
                    backupList += `
                        <div style="display: flex; justify-content: space-between; align-items: center; 
                             padding: 10px; border-bottom: 1px solid var(--border-color);">
                            <div>
                                <div style="font-weight: 500;">${date}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    ${Utils.formatFileSize(backup.size)}
                                </div>
                            </div>
                            <button class="btn btn-sm btn-accent" onclick="Storage.restore('${backup.key}')">
                                Restore
                            </button>
                        </div>
                    `;
                });
                
                Modal.show(
                    'Restore Backup',
                    `
                        <p>Select a backup to restore:</p>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${backupList}
                        </div>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 10px;">
                            Note: Restoring will replace current data with backup data.
                        </p>
                    `,
                    [
                        {
                            text: 'Close',
                            class: 'btn-outline-accent',
                            onclick: `Modal.close('${Modal.currentModalId}')`
                        }
                    ]
                );
            },
            
            // Confirm clear data
            confirmClearData() {
                Modal.confirm(
                    'Clear All Data',
                    'Are you sure you want to clear all attendance records? This action cannot be undone.',
                    () => {
                        Storage.clearAll();
                        APP_STATE.attendanceRecords = [];
                        APP_STATE.selectedRecords.clear();
                        
                        AttendanceManager.loadRecords();
                        AttendanceManager.updateStats();
                        AttendanceManager.updateBadges();
                        
                        Toast.success('All data cleared');
                    }
                );
            },
            
            // Show quick actions
            showQuickActions() {
                Modal.show(
                    'Quick Actions',
                    `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button class="btn btn-accent" onclick="EventHandlers.switchTab('attendance'); Modal.close('${Modal.currentModalId}')">
                                <i class="fas fa-camera"></i> Mark Attendance
                            </button>
                            <button class="btn btn-success" onclick="EventHandlers.switchTab('records'); Modal.close('${Modal.currentModalId}')">
                                <i class="fas fa-history"></i> View Records
                            </button>
                            <button class="btn btn-primary" onclick="AttendanceManager.exportCSV(); Modal.close('${Modal.currentModalId}')">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                            <button class="btn btn-danger" onclick="Storage.backup(); Modal.close('${Modal.currentModalId}')">
                                <i class="fas fa-save"></i> Backup Now
                            </button>
                        </div>
                    `,
                    [
                        {
                            text: 'Close',
                            class: 'btn-outline-accent',
                            onclick: `Modal.close('${Modal.currentModalId}')`
                        }
                    ]
                );
            },
            
            // Show emergency options
            showEmergencyOptions() {
                Modal.show(
                    'Emergency Options',
                    `
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <button class="btn btn-danger" onclick="EventHandlers.sendEmergencyAlert()">
                                <i class="fas fa-exclamation-triangle"></i> Send Emergency Alert
                            </button>
                            <button class="btn btn-warning" onclick="EventHandlers.exportEmergencyData()">
                                <i class="fas fa-file-export"></i> Export All Data Now
                            </button>
                            <button class="btn btn-info" onclick="EventHandlers.showCurrentLocation()">
                                <i class="fas fa-map-marker-alt"></i> Show Current Location
                            </button>
                            <button class="btn btn-secondary" onclick="EventHandlers.contactSupport()">
                                <i class="fas fa-phone-alt"></i> Contact Support
                            </button>
                        </div>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 20px;">
                            Use these options in emergency situations only.
                        </p>
                    `,
                    [
                        {
                            text: 'Close',
                            class: 'btn-outline-accent',
                            onclick: `Modal.close('${Modal.currentModalId}')`
                        }
                    ]
                );
            },
            
            // Handle name autocomplete
            handleNameAutocomplete() {
                const query = DOM.employeeName.value.toLowerCase();
                if (query.length < 2) {
                    DOM.nameAutocomplete.innerHTML = '';
                    return;
                }
                
                // Sample employee data for autocomplete
                const employees = [
                    { name: 'Rajesh Kumar', id: 'EMP001', department: 'Panchayat Development' },
                    { name: 'Priya Sharma', id: 'EMP002', department: 'Health Services' },
                    { name: 'Amit Patel', id: 'EMP003', department: 'Education' },
                    { name: 'Sneha Singh', id: 'EMP004', department: 'Administration' },
                    { name: 'Vikram Yadav', id: 'EMP005', department: 'Field Operations' },
                    { name: 'Anjali Gupta', id: 'EMP006', department: 'Panchayat Development' },
                    { name: 'Rahul Verma', id: 'EMP007', department: 'Health Services' },
                    { name: 'Meena Choudhary', id: 'EMP008', department: 'Education' }
                ];
                
                const matches = employees.filter(emp => 
                    emp.name.toLowerCase().includes(query) || 
                    emp.id.toLowerCase().includes(query)
                );
                
                if (matches.length === 0) {
                    DOM.nameAutocomplete.innerHTML = '<div class="autocomplete-item">No matches found</div>';
                    return;
                }
                
                let html = '';
                matches.forEach(emp => {
                    const initials = emp.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    
                    html += `
                        <div class="autocomplete-item" onclick="EventHandlers.selectEmployee('${emp.name}', '${emp.id}', '${emp.department}')">
                            <div class="employee-avatar">
                                ${initials.substring(0, 2)}
                            </div>
                            <div class="employee-info">
                                <div class="employee-name">${emp.name}</div>
                                <div class="employee-id">${emp.id} | ${emp.department}</div>
                            </div>
                        </div>
                    `;
                });
                
                DOM.nameAutocomplete.innerHTML = html;
            },
            
            // Select employee from autocomplete
            selectEmployee(name, id, department) {
                DOM.employeeName.value = name;
                DOM.employeeId.value = id;
                DOM.department.value = department;
                DOM.nameAutocomplete.innerHTML = '';
            },
            
            // Show QR scanner
            showQRScanner() {
                Modal.show(
                    'Scan Employee ID',
                    `
                        <div id="qr-reader" style="width: 100%;"></div>
                        <div id="qr-reader-results" style="margin-top: 20px;"></div>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 10px;">
                            Point camera at employee ID QR code
                        </p>
                    `,
                    [
                        {
                            text: 'Close',
                            class: 'btn-outline-accent',
                            onclick: `Modal.close('${Modal.currentModalId}')`
                        }
                    ]
                );
                
                // Initialize QR scanner
                setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("qr-reader");
                    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                        // Parse QR code data (assuming format: "name|id|department")
                        const parts = decodedText.split('|');
                        if (parts.length >= 3) {
                            DOM.employeeName.value = parts[0];
                            DOM.employeeId.value = parts[1];
                            DOM.department.value = parts[2];
                            
                            html5QrCode.stop().then(() => {
                                document.getElementById('qr-reader-results').innerHTML = 
                                    `<div class="alert alert-success">Employee ID scanned successfully!</div>`;
                                    
                                setTimeout(() => {
                                    Modal.close(Modal.currentModalId);
                                }, 1000);
                            });
                        }
                    };
                    
                    const config = { fps: 10, qrbox: 250 };
                    html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
                }, 100);
            },
            
            // Emergency functions
            sendEmergencyAlert() {
                if (APP_STATE.currentLocation) {
                    const location = `${APP_STATE.currentLocation.latitude}, ${APP_STATE.currentLocation.longitude}`;
                    const message = `EMERGENCY ALERT! Location: ${location}. Time: ${new Date().toLocaleString('en-IN')}`;
                    
                    Toast.error(message);
                    console.log('Emergency Alert:', message);
                } else {
                    Toast.error('Unable to send alert. Location not available.');
                }
            },
            
            exportEmergencyData() {
                AttendanceManager.exportCSV();
                AttendanceManager.exportPDF();
            },
            
            showCurrentLocation() {
                if (APP_STATE.currentLocation) {
                    const location = `${APP_STATE.currentLocation.latitude}, ${APP_STATE.currentLocation.longitude}`;
                    const address = APP_STATE.currentLocation.address || 'Address not available';
                    
                    Modal.alert(
                        'Current Location',
                        `Coordinates: ${location}<br>Address: ${address}<br>Accuracy: ${Math.round(APP_STATE.currentLocation.accuracy)} meters`
                    );
                } else {
                    Toast.error('Location not available');
                }
            },
            
            contactSupport() {
                Modal.alert(
                    'Contact Support',
                    'Emergency Contact: +91-9876543210<br>Email: support@smartattendance.com<br>Office: District Panchayat Office, Main Road'
                );
            }
        };
        
        // Application Initialization
        class SmartAttendanceApp {
            constructor() {
                this.init();
            }
            
            async init() {
                try {
                    // Update loading progress
                    this.updateLoadingProgress(10, 'Initializing DOM...');
                    
                    // Initialize DOM references
                    initDOMReferences();
                    
                    this.updateLoadingProgress(20, 'Loading settings...');
                    
                    // Load settings
                    SettingsManager.loadSettings();
                    
                    this.updateLoadingProgress(30, 'Initializing voice guide...');
                    
                    // Initialize voice guide
                    VoiceGuide.init();
                    VoiceGuide.updateUI();
                    
                    this.updateLoadingProgress(40, 'Loading data...');
                    
                    // Load data from storage
                    this.loadData();
                    
                    this.updateLoadingProgress(50, 'Initializing GPS...');
                    
                    // Initialize GPS
                    await GPSManager.init().catch(error => {
                        console.warn('GPS initialization warning:', error.message);
                    });
                    
                    this.updateLoadingProgress(60, 'Initializing camera...');
                    
                    // Initialize camera
                    await CameraManager.init().catch(error => {
                        console.warn('Camera initialization warning:', error.message);
                    });
                    
                    this.updateLoadingProgress(70, 'Initializing maps...');
                    
                    // Initialize maps
                    MapManager.initMainMap();
                    
                    this.updateLoadingProgress(80, 'Initializing analytics...');
                    
                    // Initialize analytics
                    AnalyticsManager.init();
                    
                    this.updateLoadingProgress(90, 'Setting up event handlers...');
                    
                    // Initialize event handlers
                    EventHandlers.init();
                    
                    this.updateLoadingProgress(95, 'Finalizing setup...');
                    
                    // Update UI
                    AttendanceManager.updateStats();
                    AttendanceManager.updateBadges();
                    AttendanceManager.updateRecentActivity();
                    
                    // Set up online/offline detection
                    window.addEventListener('online', () => {
                        APP_STATE.isOnline = true;
                        Toast.success('Back online. Syncing data...');
                        VoiceGuide.guide('online_mode');
                    });
                    
                    window.addEventListener('offline', () => {
                        APP_STATE.isOnline = false;
                        Toast.warning('You are offline. Working in offline mode.');
                        VoiceGuide.guide('offline_mode');
                    });
                    
                    // Set up battery status monitoring
                    if ('getBattery' in navigator) {
                        navigator.getBattery().then(battery => {
                            this.updateBatteryStatus(battery);
                            
                            battery.addEventListener('levelchange', () => {
                                this.updateBatteryStatus(battery);
                            });
                        });
                    }
                    
                    this.updateLoadingProgress(100, 'Ready!');
                    
                    // Hide loading screen after delay
                    setTimeout(() => {
                        DOM.loadingOverlay.classList.add('hidden');
                        APP_STATE.isLoading = false;
                        
                        // Welcome message
                        Toast.success('Smart Attendance System Ready!');
                        VoiceGuide.guide('welcome');
                    }, 1000);
                    
                } catch (error) {
                    console.error('Application initialization error:', error);
                    DOM.loadingText.textContent = 'Initialization failed. Please refresh the page.';
                    Toast.error('Failed to initialize application');
                }
            }
            
            // Update loading progress
            updateLoadingProgress(percent, message) {
                DOM.loadingProgress.style.width = `${percent}%`;
                DOM.loadingText.textContent = message;
            }
            
            // Load data from storage
            loadData() {
                // Load attendance records
                const savedRecords = Storage.load('attendance_records');
                if (savedRecords) {
                    APP_STATE.attendanceRecords = savedRecords;
                }
                
                // Load departments
                const savedDepts = Storage.load('departments');
                if (savedDepts) {
                    APP_STATE.departments = savedDepts;
                }
                
                // Load employees
                const savedEmps = Storage.load('employees');
                if (savedEmps) {
                    APP_STATE.employees = savedEmps;
                }
                
                // Load recent activity
                const savedActivity = Storage.load('recent_activity');
                if (savedActivity) {
                    APP_STATE.recentActivity = savedActivity;
                }
            }
            
            // Update battery status
            updateBatteryStatus(battery) {
                const level = Math.round(battery.level * 100);
                DOM.statusBattery.innerHTML = `<i class="fas fa-circle"></i> ${level}%`;
                
                if (level < 20) {
                    DOM.statusBattery.className = 'status-value status-warning';
                } else {
                    DOM.statusBattery.className = 'status-value status-active';
                }
            }
        }
        
        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new SmartAttendanceApp();
        });
        
        // Make important functions available globally
        window.Utils = Utils;
        window.Toast = Toast;
        window.Modal = Modal;
        window.VoiceGuide = VoiceGuide;
        window.GPSManager = GPSManager;
        window.CameraManager = CameraManager;
        window.AttendanceManager = AttendanceManager;
        window.MapManager = MapManager;
        window.AnalyticsManager = AnalyticsManager;
        window.SettingsManager = SettingsManager;
        window.Storage = Storage;
        window.EventHandlers = EventHandlers;
        
        // Show toast globally
        window.showToast = Toast.show;
        window.showSuccessToast = Toast.success;
        window.showErrorToast = Toast.error;
        window.showWarningToast = Toast.warning;
        window.showInfoToast = Toast.info;
    </script>
</body>
</html>
